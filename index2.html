<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Anxiety Spike Predictor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      color-scheme: dark;
    }
    body {
      margin: 0;
      padding: 20px;
      background: #050505;
      color: #e5e5e5;
    }
    .shell {
      max-width: 1040px;
      margin: 0 auto;
      background: #131313;
      border-radius: 12px;
      padding: 18px 20px 24px;
      box-shadow: 0 0 0 1px #262626;
    }
    h1 {
      font-size: 1.6rem;
      margin: 0 0 6px;
    }
    p {
      margin: 4px 0 10px;
      color: #b0b0b0;
      font-size: 0.9rem;
    }
    .mode-toggle {
      display: inline-flex;
      border-radius: 999px;
      border: 1px solid #333;
      overflow: hidden;
      margin-top: 8px;
      margin-bottom: 10px;
    }
    .mode-toggle button {
      border: none;
      background: transparent;
      color: #d0d0d0;
      font-size: 0.85rem;
      padding: 6px 14px;
      cursor: pointer;
    }
    .mode-toggle button.active {
      background: #2c76ff;
      color: #050505;
    }
    label {
      display: block;
      font-size: 0.82rem;
      color: #cfcfcf;
      margin-bottom: 3px;
    }
    input[type="number"],
    select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #333;
      background: #0d0d0d;
      color: #f5f5f5;
      font-size: 0.88rem;
      box-sizing: border-box;
    }
    input[type="range"] {
      width: 100%;
    }
    input:focus,
    select:focus {
      outline: none;
      border-color: #4d96ff;
    }
    .hint {
      margin-top: 3px;
      font-size: 0.75rem;
      color: #808080;
    }
    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }
    .pill {
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid #333;
      font-size: 0.78rem;
      cursor: pointer;
      user-select: none;
      background: #101010;
    }
    .pill.selected {
      background: #2c76ff;
      border-color: #2c76ff;
      color: #050505;
    }
    button.primary {
      margin-top: 16px;
      padding: 10px 18px;
      border-radius: 8px;
      border: none;
      background: #2c76ff;
      color: #050505;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
    }
    button.primary:hover {
      background: #5e97ff;
    }
    button.secondary {
      margin-top: 10px;
      padding: 8px 14px;
      border-radius: 8px;
      border: 1px solid #333;
      background: #181818;
      color: #f0f0f0;
      font-size: 0.85rem;
      cursor: pointer;
    }
    button.secondary:hover {
      background: #222;
    }
    .mode-section {
      margin-top: 6px;
    }
    .hidden {
      display: none;
    }
    .grid-advanced {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px 20px;
      margin-top: 10px;
    }
    /* Meal grid */
    .meal-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-top: 10px;
      margin-bottom: 6px;
    }
    .meal-search {
      flex: 1;
    }
    .meal-search input {
      width: 100%;
      padding: 6px 9px;
      border-radius: 999px;
      border: 1px solid #333;
      background: #0d0d0d;
      color: #eee;
      font-size: 0.86rem;
      box-sizing: border-box;
    }
    .meal-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      max-height: 280px;
      overflow-y: auto;
      padding-right: 4px;
      margin-top: 4px;
    }
    .meal-card {
      background: #101010;
      border-radius: 9px;
      padding: 8px 9px;
      border: 1px solid #262626;
      cursor: pointer;
      font-size: 0.8rem;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    .meal-card.selected {
      border-color: #2c76ff;
      box-shadow: 0 0 0 1px #2c76ff55;
    }
    .meal-emoji {
      font-size: 1.3rem;
    }
    .meal-title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }
    .meal-name {
      font-weight: 600;
      font-size: 0.82rem;
    }
    .meal-tag {
      font-size: 0.68rem;
      padding: 1px 6px;
      border-radius: 999px;
      background: #1f1f1f;
      color: #ccc;
    }
    .meal-macros {
      font-size: 0.74rem;
      color: #a0a0a0;
    }
    .meal-cat {
      font-size: 0.72rem;
      color: #808080;
    }
    .subgrid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
      gap: 12px 20px;
      margin-top: 12px;
    }
    .output {
      margin-top: 18px;
      padding-top: 12px;
      border-top: 1px solid #262626;
      font-size: 0.9rem;
    }
    .score-line {
      font-size: 1.05rem;
      margin-bottom: 4px;
    }
    .tag {
      display: inline-block;
      padding: 2px 9px;
      border-radius: 999px;
      font-size: 0.75rem;
      margin-left: 8px;
    }
    .tag-low {
      background: #11381f;
      color: #83e59a;
    }
    .tag-mod {
      background: #3c330f;
      color: #ffd469;
    }
    .tag-high {
      background: #3b1414;
      color: #ff8f8f;
    }
    .row {
      margin-top: 6px;
    }
    .small {
      font-size: 0.8rem;
      color: #8b8b8b;
      margin-top: 3px;
    }
    .timeline {
      margin-top: 10px;
      font-family: "SF Mono", Menlo, Consolas, monospace;
      font-size: 0.78rem;
      background: #101010;
      border-radius: 8px;
      padding: 8px 10px;
      border: 1px solid #262626;
    }
    .bar {
      position: relative;
      height: 10px;
      background: #1b1b1b;
      border-radius: 999px;
      overflow: hidden;
      margin: 4px 0 6px;
    }
    .segment {
      position: absolute;
      top: 0;
      bottom: 0;
      border-radius: 999px;
    }
    .segment.spike {
      background: #f1c453;
    }
    .segment.crash {
      background: #f94144;
    }
    .segment.recover {
      background: #3a86ff;
    }
    .history {
      margin-top: 14px;
      padding-top: 10px;
      border-top: 1px dashed #303030;
      font-size: 0.8rem;
    }
    .history h3 {
      font-size: 0.9rem;
      margin: 0 0 4px;
    }
    .history-item {
      margin-top: 4px;
      color: #b3b3b3;
    }
    .badge {
      display: inline-block;
      padding: 1px 6px;
      border-radius: 6px;
      font-size: 0.7rem;
      background: #202020;
      margin-left: 6px;
      color: #ccc;
    }
    .explain {
      margin-top: 10px;
      font-size: 0.8rem;
      color: #b0b0b0;
      background: #151515;
      border-radius: 8px;
      padding: 8px 10px;
      border: 1px solid #262626;
    }
    .section-title {
      font-size: 0.95rem;
      margin-top: 14px;
      margin-bottom: 4px;
      font-weight: 600;
    }
    .reverse-block {
      margin-top: 12px;
      padding-top: 10px;
      border-top: 1px solid #262626;
      font-size: 0.84rem;
    }
    .reverse-grid {
      display: grid;
      grid-template-columns: minmax(140px, 220px) 1fr;
      gap: 10px 18px;
      align-items: center;
    }
    @media (max-width: 720px) {
      .reverse-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="shell">
    <h1>Anxiety Spike Predictor</h1>
    <p>
      Estimates when a meal and caffeine are likely to cause a spike, a crash and an anxiety window,
      based on carbs, sugar, caffeine and sensitivity. Educational only. Not medical advice.
    </p>

    <div class="mode-toggle">
      <button id="simpleModeBtn" class="active">Simple mode</button>
      <button id="advancedModeBtn">Advanced mode</button>
    </div>

    <!-- SIMPLE MODE -->
    <div id="simpleMode" class="mode-section">
      <div class="meal-header-row">
        <div>
          <label>Main meal type</label>
          <div class="hint">Pick the meal that looks most like what you ate.</div>
        </div>
        <div class="meal-search">
          <input id="mealSearch" type="text" placeholder="Search meals (pasta, ramen, burrito, sushi...)" />
        </div>
      </div>
      <div id="mealGrid" class="meal-grid">
        <!-- Meal cards injected by JS -->
      </div>

      <div class="subgrid">
        <div>
          <label>Portion size</label>
          <div class="pill-row" id="portionGroup">
            <div class="pill selected" data-portion="medium">Medium</div>
            <div class="pill" data-portion="small">Small</div>
            <div class="pill" data-portion="large">Large</div>
            <div class="pill" data-portion="restaurant">Restaurant sized</div>
          </div>
          <div class="hint">Controls how big the carb hit is.</div>
        </div>

        <div>
          <label>Sweet stuff with this meal</label>
          <div class="pill-row" id="sweetGroup">
            <div class="pill selected" data-sweet="none">None</div>
            <div class="pill" data-sweet="little">A little</div>
            <div class="pill" data-sweet="medium">Dessert portion</div>
            <div class="pill" data-sweet="lot">Big dessert or sugary drink</div>
          </div>
        </div>

        <div>
          <label>Caffeine around this time</label>
          <div class="pill-row" id="caffTypeGroup">
            <div class="pill selected" data-caff="none">None</div>
            <div class="pill" data-caff="tea">Tea</div>
            <div class="pill" data-caff="soda">Soda</div>
            <div class="pill" data-caff="smallCoffee">Small coffee</div>
            <div class="pill" data-caff="medCoffee">Medium coffee</div>
            <div class="pill" data-caff="largeCoffee">Large coffee</div>
            <div class="pill" data-caff="energy">Energy drink</div>
          </div>
          <div class="hint">We estimate caffeine in mg from this.</div>
        </div>

        <div>
          <label>Time of this meal</label>
          <div class="pill-row" id="todGroup">
            <div class="pill" data-tod="morning">Morning</div>
            <div class="pill" data-tod="afternoon">Afternoon</div>
            <div class="pill selected" data-tod="evening">Evening or night</div>
          </div>
        </div>

        <div>
          <label>How carb heavy was earlier today?</label>
          <input id="simpleStack" type="range" min="0" max="2" step="1" value="1" />
          <div class="hint" id="simpleStackLabel">Medium. One normal carb meal earlier.</div>
        </div>

        <div>
          <label>Your sensitivity to carbs and sugar</label>
          <input id="simpleSens" type="range" min="1" max="5" step="1" value="5" />
          <div class="hint" id="simpleSensLabel">5 of 5. Very high sensitivity.</div>
        </div>

        <div>
          <label>Your sensitivity to caffeine</label>
          <input id="simpleCaffSens" type="range" min="1" max="5" step="1" value="3" />
          <div class="hint" id="simpleCaffSensLabel">3 of 5. Average sensitivity.</div>
        </div>
      </div>
    </div>

    <!-- ADVANCED MODE -->
    <div id="advancedMode" class="mode-section hidden">
      <div class="grid-advanced">
        <div>
          <label for="advCarbs">Carbs in this meal (g)</label>
          <input id="advCarbs" type="number" value="80" />
          <div class="hint">Estimate total starch and carb content.</div>
        </div>

        <div>
          <label for="advSugar">Added sugar (g)</label>
          <input id="advSugar" type="number" value="10" />
          <div class="hint">Dessert, sweet drinks, candy.</div>
        </div>

        <div>
          <label for="advFiber">Fiber (g)</label>
          <input id="advFiber" type="number" value="3" />
          <div class="hint">Vegetables and whole grains.</div>
        </div>

        <div>
          <label for="advFat">Fat level</label>
          <select id="advFat">
            <option value="0">Low</option>
            <option value="1" selected>Medium</option>
            <option value="2">High</option>
          </select>
        </div>

        <div>
          <label for="advSens">Carb and sugar sensitivity (1 to 5)</label>
          <input id="advSens" type="number" min="1" max="5" value="5" />
        </div>

        <div>
          <label for="advPrior">Total carbs earlier today (g)</label>
          <input id="advPrior" type="number" value="60" />
        </div>

        <div>
          <label for="advTod">Time of this meal</label>
          <select id="advTod">
            <option value="morning">Morning</option>
            <option value="afternoon">Afternoon</option>
            <option value="evening" selected>Evening or night</option>
          </select>
        </div>

        <div>
          <label for="advCaff">Caffeine around this time (mg)</label>
          <input id="advCaff" type="number" value="0" />
        </div>

        <div>
          <label for="advCaffSens">Caffeine sensitivity (1 to 5)</label>
          <input id="advCaffSens" type="number" min="1" max="5" value="3" />
        </div>
      </div>
    </div>

    <button class="primary" id="calcBtn">Calculate anxiety risk</button>
    <button class="secondary" id="dontKnowBtn">I did not track, give a rough guess</button>

    <div class="output" id="output"></div>

    <div class="reverse-block">
      <div class="section-title">I feel anxious right now</div>
      <div class="reverse-grid">
        <div>
          <label for="minutesSince">Minutes since this meal</label>
          <input id="minutesSince" type="number" value="90" />
          <div class="hint">
            Works best if you just ran a prediction for the meal that might be causing this.
          </div>
          <button class="secondary" id="whyNowBtn">Why am I feeling this now?</button>
        </div>
        <div id="whyNowOutput" class="small">
          This will try to map your current moment to spike, crash or recovery based on your last prediction.
        </div>
      </div>
    </div>

    <div class="history" id="historyBlock">
      <h3>Last few runs</h3>
      <div id="historyList"></div>
    </div>

    <div class="explain">
      <strong>How this thinks:</strong>
      Carbs and sugar create a blood sugar spike. Your body responds with insulin and later a drop.
      That drop can trigger adrenaline and vagus nerve signals which feel like anxiety. Caffeine, timing,
      stacking from earlier meals and your sensitivity change how loud that feels. This tool treats anxiety
      as partly biological, not just psychological.
    </div>
  </div>

  <script>
    function clamp(value, min, max) {
      return Math.max(min, Math.min(max, value));
    }

    // Meal presets
    const mealPresets = [
      {
        id: "pasta",
        emoji: "ðŸ",
        name: "Plate of pasta",
        category: "Italian / comfort",
        carbs: 80,
        fiber: 3,
        fatLevel: 1,
        sugarBase: 3,
        tag: "High carb"
      },
      {
        id: "riceBowl",
        emoji: "ðŸš",
        name: "Rice bowl",
        category: "Rice based meal",
        carbs: 70,
        fiber: 2,
        fatLevel: 0,
        sugarBase: 2,
        tag: "High carb"
      },
      {
        id: "pizza2",
        emoji: "ðŸ•",
        name: "Pizza, 2 slices",
        category: "Pizza",
        carbs: 60,
        fiber: 3,
        fatLevel: 2,
        sugarBase: 3,
        tag: "High carb / fat"
      },
      {
        id: "burgerFries",
        emoji: "ðŸ”",
        name: "Burger with fries",
        category: "Fast food",
        carbs: 70,
        fiber: 4,
        fatLevel: 2,
        sugarBase: 4,
        tag: "Heavy"
      },
      {
        id: "burgerOnly",
        emoji: "ðŸ”",
        name: "Burger, no fries",
        category: "Fast food",
        carbs: 45,
        fiber: 2,
        fatLevel: 2,
        sugarBase: 2,
        tag: "Medium carb"
      },
      {
        id: "burrito",
        emoji: "ðŸŒ¯",
        name: "Burrito",
        category: "Mexican style",
        carbs: 75,
        fiber: 6,
        fatLevel: 2,
        sugarBase: 3,
        tag: "High carb"
      },
      {
        id: "tacos",
        emoji: "ðŸŒ®",
        name: "Tacos (2-3)",
        category: "Mexican style",
        carbs: 45,
        fiber: 4,
        fatLevel: 1,
        sugarBase: 2,
        tag: "Medium carb"
      },
      {
        id: "ramen",
        emoji: "ðŸœ",
        name: "Ramen / noodle bowl",
        category: "Asian noodles",
        carbs: 65,
        fiber: 3,
        fatLevel: 1,
        sugarBase: 3,
        tag: "High carb"
      },
      {
        id: "friedRice",
        emoji: "ðŸ›",
        name: "Fried rice",
        category: "Rice based meal",
        carbs: 75,
        fiber: 3,
        fatLevel: 2,
        sugarBase: 3,
        tag: "High carb"
      },
      {
        id: "sushi6",
        emoji: "ðŸ£",
        name: "Sushi, 6 pieces",
        category: "Sushi",
        carbs: 40,
        fiber: 2,
        fatLevel: 0,
        sugarBase: 2,
        tag: "Medium carb"
      },
      {
        id: "sushi12",
        emoji: "ðŸ£",
        name: "Sushi, 12 pieces",
        category: "Sushi",
        carbs: 70,
        fiber: 3,
        fatLevel: 0,
        sugarBase: 2,
        tag: "High carb"
      },
      {
        id: "cereal",
        emoji: "ðŸ¥£",
        name: "Cereal bowl",
        category: "Breakfast",
        carbs: 55,
        fiber: 3,
        fatLevel: 0,
        sugarBase: 8,
        tag: "Sugary"
      },
      {
        id: "friesSide",
        emoji: "ðŸŸ",
        name: "Side of fries",
        category: "Side",
        carbs: 40,
        fiber: 3,
        fatLevel: 2,
        sugarBase: 1,
        tag: "High fat"
      },
      {
        id: "potato",
        emoji: "ðŸ¥”",
        name: "Potato dish",
        category: "Potato based",
        carbs: 60,
        fiber: 4,
        fatLevel: 1,
        sugarBase: 1,
        tag: "High carb"
      },
      {
        id: "saladLowCarb",
        emoji: "ðŸ¥—",
        name: "Salad, low carb",
        category: "Lighter meal",
        carbs: 18,
        fiber: 6,
        fatLevel: 1,
        sugarBase: 1,
        tag: "Light"
      },
      {
        id: "proteinMeal",
        emoji: "ðŸ—",
        name: "Protein heavy, low carb",
        category: "Protein focused",
        carbs: 20,
        fiber: 3,
        fatLevel: 1,
        sugarBase: 1,
        tag: "Lower carb"
      },
      {
        id: "sandwich",
        emoji: "ðŸ¥ª",
        name: "Sandwich",
        category: "Bread based",
        carbs: 45,
        fiber: 4,
        fatLevel: 1,
        sugarBase: 2,
        tag: "Medium carb"
      },
      {
        id: "subFootlong",
        emoji: "ðŸ¥–",
        name: "Footlong sub",
        category: "Sandwich chain style",
        carbs: 80,
        fiber: 6,
        fatLevel: 1,
        sugarBase: 4,
        tag: "High carb"
      },
      {
        id: "chipotleBurrito",
        emoji: "ðŸŒ¯",
        name: "Chipotle style burrito",
        category: "Mexican chain style",
        carbs: 90,
        fiber: 8,
        fatLevel: 2,
        sugarBase: 4,
        tag: "Heavy"
      },
      {
        id: "orangeChickenRice",
        emoji: "ðŸ›",
        name: "Orange chicken + rice",
        category: "Chinese chain style",
        carbs: 85,
        fiber: 3,
        fatLevel: 2,
        sugarBase: 10,
        tag: "High carb / sugar"
      },
      {
        id: "padThai",
        emoji: "ðŸœ",
        name: "Pad Thai",
        category: "Thai noodles",
        carbs: 85,
        fiber: 4,
        fatLevel: 2,
        sugarBase: 10,
        tag: "High carb / sugar"
      },
      {
        id: "dessertOnly",
        emoji: "ðŸ°",
        name: "Dessert only",
        category: "Sweet heavy",
        carbs: 55,
        fiber: 1,
        fatLevel: 1,
        sugarBase: 30,
        tag: "Sugary"
      },
      {
        id: "otherHeavy",
        emoji: "ðŸ½ï¸",
        name: "Other heavy carb meal",
        category: "General",
        carbs: 75,
        fiber: 3,
        fatLevel: 1,
        sugarBase: 3,
        tag: "Heavy"
      }
    ];

    // Render meal grid
    const mealGrid = document.getElementById("mealGrid");
    const mealSearch = document.getElementById("mealSearch");
    let selectedMealId = "pasta";

    function renderMealGrid(filterText = "") {
      const text = filterText.trim().toLowerCase();
      mealGrid.innerHTML = "";

      const list = mealPresets.filter((m) => {
        if (!text) return true;
        return (
          m.name.toLowerCase().includes(text) ||
          m.category.toLowerCase().includes(text) ||
          (m.tag && m.tag.toLowerCase().includes(text))
        );
      });

      list.forEach((meal) => {
        const card = document.createElement("div");
        card.className = "meal-card";
        if (meal.id === selectedMealId) {
          card.classList.add("selected");
        }
        card.dataset.mealId = meal.id;
        card.innerHTML = `
          <div class="meal-title-row">
            <span class="meal-emoji">${meal.emoji}</span>
            <span class="meal-name">${meal.name}</span>
            <span class="meal-tag">${meal.tag}</span>
          </div>
          <div class="meal-macros">Carbs ~${meal.carbs}g, fiber ~${meal.fiber}g, fat: ${
          meal.fatLevel === 2 ? "high"
            : meal.fatLevel === 1 ? "medium"
            : "low"
        }</div>
          <div class="meal-cat">${meal.category}</div>
        `;
        card.addEventListener("click", () => {
          selectedMealId = meal.id;
          [...mealGrid.querySelectorAll(".meal-card")].forEach((c) =>
            c.classList.remove("selected")
          );
          card.classList.add("selected");
        });
        mealGrid.appendChild(card);
      });
    }

    mealSearch.addEventListener("input", () => {
      renderMealGrid(mealSearch.value);
    });

    renderMealGrid();

    // Attach pill group logic
    function makeSingleSelect(groupId) {
      const group = document.getElementById(groupId);
      if (!group) return;
      group.addEventListener("click", (e) => {
        const pill = e.target.closest(".pill");
        if (!pill) return;
        [...group.querySelectorAll(".pill")].forEach((p) =>
          p.classList.remove("selected")
        );
        pill.classList.add("selected");
      });
    }

    makeSingleSelect("portionGroup");
    makeSingleSelect("sweetGroup");
    makeSingleSelect("caffTypeGroup");
    makeSingleSelect("todGroup");

    // Simple sliders labels
    const stackInput = document.getElementById("simpleStack");
    const stackLabel = document.getElementById("simpleStackLabel");
    const sensInput = document.getElementById("simpleSens");
    const sensLabel = document.getElementById("simpleSensLabel");
    const caffSensInput = document.getElementById("simpleCaffSens");
    const caffSensLabel = document.getElementById("simpleCaffSensLabel");

    function updateStackLabel() {
      const v = parseInt(stackInput.value, 10);
      if (v === 0) {
        stackLabel.textContent = "Low. Mostly light or low carb earlier.";
      } else if (v === 1) {
        stackLabel.textContent = "Medium. One normal carb meal earlier.";
      } else {
        stackLabel.textContent =
          "High. Two or more carb heavy meals earlier today.";
      }
    }
    function updateSensLabel() {
      const v = parseInt(sensInput.value, 10);
      if (v <= 2) {
        sensLabel.textContent = v + " of 5. Mild sensitivity.";
      } else if (v === 3) {
        sensLabel.textContent = "3 of 5. Average sensitivity.";
      } else if (v === 4) {
        sensLabel.textContent = "4 of 5. High sensitivity.";
      } else {
        sensLabel.textContent = "5 of 5. Very high sensitivity.";
      }
    }
    function updateCaffSensLabel() {
      const v = parseInt(caffSensInput.value, 10);
      if (v <= 2) {
        caffSensLabel.textContent = v + " of 5. Handles caffeine fairly well.";
      } else if (v === 3) {
        caffSensLabel.textContent = "3 of 5. Typical response.";
      } else if (v === 4) {
        caffSensLabel.textContent = "4 of 5. Sensitive to caffeine.";
      } else {
        caffSensLabel.textContent = "5 of 5. Very sensitive to caffeine.";
      }
    }

    stackInput.addEventListener("input", updateStackLabel);
    sensInput.addEventListener("input", updateSensLabel);
    caffSensInput.addEventListener("input", updateCaffSensLabel);
    updateStackLabel();
    updateSensLabel();
    updateCaffSensLabel();

    // Mode toggle
    const simpleModeBtn = document.getElementById("simpleModeBtn");
    const advancedModeBtn = document.getElementById("advancedModeBtn");
    const simpleMode = document.getElementById("simpleMode");
    const advancedMode = document.getElementById("advancedMode");

    function setMode(mode) {
      if (mode === "simple") {
        simpleModeBtn.classList.add("active");
        advancedModeBtn.classList.remove("active");
        simpleMode.classList.remove("hidden");
        advancedMode.classList.add("hidden");
      } else {
        advancedModeBtn.classList.add("active");
        simpleModeBtn.classList.remove("active");
        advancedMode.classList.remove("hidden");
        simpleMode.classList.add("hidden");
      }
    }

    simpleModeBtn.addEventListener("click", () => setMode("simple"));
    advancedModeBtn.addEventListener("click", () => setMode("advanced"));

    function getSelectedDataAttr(groupId, attr, fallback) {
      const group = document.getElementById(groupId);
      const selected = group.querySelector(".pill.selected");
      if (!selected) return fallback;
      return selected.getAttribute(attr) || fallback;
    }

    // Simple mode input build
    function buildInputFromSimple() {
      const meal = mealPresets.find((m) => m.id === selectedMealId) || mealPresets[0];
      const portion = getSelectedDataAttr("portionGroup", "data-portion", "medium");
      const sweet = getSelectedDataAttr("sweetGroup", "data-sweet", "none");
      const caffType = getSelectedDataAttr("caffTypeGroup", "data-caff", "none");
      const tod = getSelectedDataAttr("todGroup", "data-tod", "evening");

      // Base from meal
      let baseCarbs = meal.carbs;
      let baseFiber = meal.fiber;
      let baseFatLevel = meal.fatLevel;

      // Portion multiplier
      let mult = 1;
      if (portion === "small") mult = 0.6;
      if (portion === "large") mult = 1.4;
      if (portion === "restaurant") mult = 1.7;

      let carbs = baseCarbs * mult;
      let fiber = baseFiber * mult;

      // Sweet mapping
      let sugar = 0;
      if (sweet === "little") sugar = 8;
      if (sweet === "medium") sugar = 20;
      if (sweet === "lot") sugar = 35;

      // some of that sugar is on top of meal carbs
      carbs += sugar * 0.3;

      // Caffeine mapping
      let caffMg = 0;
      if (caffType === "tea") caffMg = 30;
      if (caffType === "soda") caffMg = 40;
      if (caffType === "smallCoffee") caffMg = 80;
      if (caffType === "medCoffee") caffMg = 120;
      if (caffType === "largeCoffee") caffMg = 180;
      if (caffType === "energy") caffMg = 160;

      // Prior carb stacking mapping
      const stackVal = parseInt(stackInput.value, 10);
      let priorCarbs = 0;
      if (stackVal === 0) priorCarbs = 20;
      if (stackVal === 1) priorCarbs = 60;
      if (stackVal === 2) priorCarbs = 130;

      const sensitivity = parseInt(sensInput.value, 10) || 3;
      const caffSens = parseInt(caffSensInput.value, 10) || 3;

      return {
        carbs,
        sugar,
        fiber,
        fatLevel: baseFatLevel,
        sensitivity,
        priorCarbs,
        timeOfDay: tod,
        caffMg,
        caffSens,
        mealName: meal.name
      };
    }

    // Advanced mode input build
    function buildInputFromAdvanced() {
      const carbs = parseFloat(document.getElementById("advCarbs").value) || 0;
      const sugar = parseFloat(document.getElementById("advSugar").value) || 0;
      const fiber = parseFloat(document.getElementById("advFiber").value) || 0;
      const fatLevel = parseInt(document.getElementById("advFat").value, 10) || 0;
      const sensitivity = parseFloat(document.getElementById("advSens").value) || 3;
      const priorCarbs = parseFloat(document.getElementById("advPrior").value) || 0;
      const timeOfDay = document.getElementById("advTod").value;
      const caffMg = parseFloat(document.getElementById("advCaff").value) || 0;
      const caffSens = parseFloat(document.getElementById("advCaffSens").value) || 3;

      return {
        carbs,
        sugar,
        fiber,
        fatLevel,
        sensitivity,
        priorCarbs,
        timeOfDay,
        caffMg,
        caffSens,
        mealName: "Custom meal"
      };
    }

    // Core biology engine
    function computeAnxietyRisk(input) {
      const {
        carbs,
        sugar,
        fiber,
        fatLevel,
        sensitivity,
        priorCarbs,
        timeOfDay,
        caffMg,
        caffSens,
        mealName
      } = input;

      // Effective load
      let L = carbs + 1.3 * sugar - 0.5 * fiber;
      if (L < 0) L = 0;

      // Spike timing
      let spikeShift = 0;
      if (fatLevel === 1) spikeShift = 5;
      if (fatLevel === 2) spikeShift = 10;

      const spikeMin = 20 + spikeShift;
      let spikeMax = 40 + spikeShift;

      // Crash timing
      let crashMin = spikeMax + 40;
      let crashMax = spikeMax + 80;
      if (L > 100) crashMax += 10;

      // Carb risk
      const Lcap = Math.min(L, 120);
      const loadScore = 60 * (Lcap / 120);
      const sensScore = 25 * (clamp(sensitivity, 1, 5) / 5);

      const Pcap = Math.min(Math.max(priorCarbs, 0), 150);
      const stackScore = 10 * (Pcap / 150);

      const evening = timeOfDay === "evening" ? 1 : 0;
      const eveningScore = evening ? 5 : 0;

      let carbRiskRaw = loadScore + sensScore + stackScore + eveningScore;
      let carbRisk = clamp(carbRiskRaw, 0, 100);

      // Caffeine risk
      let doseScore = 0;
      if (caffMg > 0 && caffMg <= 40) {
        doseScore = 10 * (caffMg / 40);
      } else if (caffMg > 40 && caffMg <= 120) {
        doseScore = 10 + 20 * ((caffMg - 40) / 80);
      } else if (caffMg > 120) {
        doseScore = 35;
      }

      const caffSensScore = 25 * (clamp(caffSens, 1, 5) / 5);

      let isLateCaffeine = 0;
      if (caffMg > 0 && (timeOfDay === "afternoon" || timeOfDay === "evening")) {
        isLateCaffeine = 1;
      }
      const timeOfDayScore = isLateCaffeine ? 5 : 0;

      let caffRiskRaw = doseScore + caffSensScore + timeOfDayScore;
      let caffRisk = Math.min(caffRiskRaw, 65);
      if (caffMg <= 0) caffRisk = 0;

      // Caffeine window
      const caffAnxMin = caffMg > 0 ? 30 : null;
      const caffAnxMax = caffMg > 0 ? 180 : null;

      let overlap = false;
      if (caffMg > 0) {
        if (!(crashMax < caffAnxMin || caffAnxMax < crashMin)) {
          overlap = true;
        }
      }

      // Synergy
      let synergyScore = 0;
      if (overlap && carbRisk > 20 && caffRisk > 10) {
        synergyScore = 0.15 * Math.min(carbRisk, caffRisk);
      }

      // Final risk
      let combinedRaw = carbRisk + caffRisk + synergyScore;
      let anxietyRisk = clamp(combinedRaw, 0, 100);

      let level = "Low";
      if (anxietyRisk >= 60) level = "High";
      else if (anxietyRisk >= 30) level = "Moderate";

      // Stacking text
      let stackingText = "Low";
      if (Pcap >= 40 && Pcap < 100) stackingText = "Medium";
      if (Pcap >= 100) stackingText = "High";

      // G impact
      const gImpact = clamp((L / 140) * 100, 0, 100);

      return {
        anxietyRisk,
        level,
        spikeMin,
        spikeMax,
        crashMin,
        crashMax,
        carbRisk,
        caffRisk,
        synergyScore,
        L,
        stackingText,
        timeOfDay,
        caffMg,
        overlap,
        gImpact,
        mealName
      };
    }

    function formatRange(min, max) {
      return `${Math.round(min)} to ${Math.round(max)} minutes after this meal`;
    }

    function buildTimelineHTML(result) {
      const total = Math.max(result.crashMax + 40, 200);
      function pct(x) {
        return clamp((x / total) * 100, 0, 100);
      }
      const spikeStart = pct(result.spikeMin);
      const spikeEnd = pct(result.spikeMax);
      const crashStart = pct(result.crashMin);
      const crashEnd = pct(result.crashMax);
      const recoverStart = crashEnd;
      const recoverEnd = pct(result.crashMax + 40);

      return `
        <div class="timeline">
          <div>Timeline</div>
          <div class="bar">
            <div class="segment spike" style="left:${spikeStart}%; width:${spikeEnd -
        spikeStart
      }%;"></div>
            <div class="segment crash" style="left:${crashStart}%; width:${crashEnd -
        crashStart
      }%;"></div>
            <div class="segment recover" style="left:${recoverStart}%; width:${recoverEnd -
        recoverStart
      }%;"></div>
          </div>
          <div class="small">
            Yellow = spike. Red = crash and anxiety window. Blue = recovery.
          </div>
        </div>
      `;
    }

    function buildExplanation(result) {
      const pieces = [];
      if (result.L >= 80) {
        pieces.push("Large carb and sugar load.");
      } else if (result.L >= 40) {
        pieces.push("Moderate carb load.");
      } else {
        pieces.push("Carb load was relatively small.");
      }
      if (result.timeOfDay === "evening") {
        pieces.push("Evening timing increases risk for sensitive guts.");
      }
      if (result.stackingText === "High") {
        pieces.push("High stacking from earlier carb heavy meals.");
      } else if (result.stackingText === "Medium") {
        pieces.push("Some stacking from earlier carbs today.");
      }
      if (result.caffMg > 0) {
        pieces.push("Caffeine overlaps with the crash window, which can amplify jittery anxiety.");
      } else {
        pieces.push("No caffeine, so this is a pure carb and timing effect.");
      }
      return pieces.join(" ");
    }

    function buildSafeSwap(result) {
      const name = (result.mealName || "").toLowerCase();
      if (name.includes("pasta") || name.includes("ramen") || name.includes("pad thai")) {
        return "Next time, try a smaller portion of noodles, add more protein and vegetables, and move it earlier in the day. That can drop the crash risk quite a bit.";
      }
      if (name.includes("pizza")) {
        return "For pizza, slower eating, fewer slices and adding a salad instead of fries usually makes the crash quieter.";
      }
      if (name.includes("burrito") || name.includes("chipotle")) {
        return "For burrito style meals, consider a bowl with less rice and more beans and protein. That tends to flatten the spike.";
      }
      if (name.includes("orange chicken") || name.includes("fried rice")) {
        return "Chinese chain style meals are often sugar heavy. Reducing sauce, adding plain rice and mixing in vegetables can ease the crash.";
      }
      if (name.includes("sushi")) {
        return "Sushi is often gentler. Spacing rolls out and limiting sugary sauces keeps risk lower.";
      }
      if (name.includes("dessert")) {
        return "If dessert alone triggers anxiety, pairing it with a small protein snack first and keeping the portion modest can help.";
      }
      return "In general, smaller portions, more fiber and protein, and earlier timing reduce the size of the spike and how loud the crash feels.";
    }

    // History
    const history = [];
    const historyList = document.getElementById("historyList");
    let lastResult = null;

    function addToHistory(result) {
      const timeLabel =
        result.timeOfDay.charAt(0).toUpperCase() +
        result.timeOfDay.slice(1);

      history.unshift({
        score: Math.round(result.anxietyRisk),
        level: result.level,
        stack: result.stackingText,
        tod: timeLabel,
        mealName: result.mealName || "Meal"
      });
      if (history.length > 5) history.pop();

      historyList.innerHTML = history
        .map(
          (h, idx) =>
            `<div class="history-item">
               Run ${history.length - idx}:
               <strong>${h.mealName}</strong> 
               Score ${h.score} of 100
               <span class="badge">${h.level}</span>
               <span class="badge">Stacking: ${h.stack}</span>
               <span class="badge">${h.tod}</span>
             </div>`
        )
        .join("");
    }

    const output = document.getElementById("output");
    const calcBtn = document.getElementById("calcBtn");
    const dontKnowBtn = document.getElementById("dontKnowBtn");
    const minutesSinceInput = document.getElementById("minutesSince");
    const whyNowBtn = document.getElementById("whyNowBtn");
    const whyNowOutput = document.getElementById("whyNowOutput");

    function renderResult(result) {
      let tagClass = "tag-low";
      if (result.level === "Moderate") tagClass = "tag-mod";
      if (result.level === "High") tagClass = "tag-high";

      const explanation = buildExplanation(result);
      const timeline = buildTimelineHTML(result);
      const safeSwap = buildSafeSwap(result);

      output.innerHTML = `
        <div class="score-line">
          Anxiety risk:
          <strong>${Math.round(result.anxietyRisk)}</strong> / 100
          <span class="tag ${tagClass}">${result.level}</span>
        </div>
        <div class="row">
          Glucose impact (G-Impact):
          <strong>${Math.round(result.gImpact)}</strong> / 100
          <span class="small">(rough strength of the spike)</span>
        </div>
        <div class="row">
          Effective glucose load:
          <strong>${result.L.toFixed(1)} g</strong>
          <span class="small">(carb and sugar adjusted for fiber)</span>
        </div>
        <div class="row">
          Spike window:
          <strong>${formatRange(result.spikeMin, result.spikeMax)}</strong>
        </div>
        <div class="row">
          Crash and anxiety window:
          <strong>${formatRange(result.crashMin, result.crashMax)}</strong>
        </div>
        <div class="row">
          Carb based anxiety risk:
          <strong>${Math.round(result.carbRisk)}</strong> / 100
        </div>
        <div class="row">
          Caffeine based anxiety risk:
          <strong>${Math.round(result.caffRisk)}</strong> / 100
        </div>
        <div class="row">
          Synergy bonus from carb and caffeine overlap:
          <strong>${result.synergyScore.toFixed(1)}</strong> points
        </div>
        <div class="row">
          Stacking from earlier today:
          <strong>${result.stackingText}</strong>
        </div>
        ${timeline}
        <div class="small" style="margin-top:6px;">
          This is a rough biological model. It is meant to help you see patterns, not to label you as broken.
        </div>
        <div class="small" style="margin-top:6px;">
          ${explanation}
        </div>
        <div class="small" style="margin-top:6px;">
          Safe swap idea: ${safeSwap}
        </div>
      `;
    }

    calcBtn.addEventListener("click", () => {
      const mode = simpleMode.classList.contains("hidden") ? "advanced" : "simple";
      const input =
        mode === "simple" ? buildInputFromSimple() : buildInputFromAdvanced();
      const result = computeAnxietyRisk(input);
      lastResult = result;
      renderResult(result);
      addToHistory(result);
    });

    dontKnowBtn.addEventListener("click", () => {
      // Rough guess: big carb evening meal, dessert, no caffeine tracking
      selectedMealId = "otherHeavy";
      renderMealGrid(mealSearch.value);
      stackInput.value = 2;
      updateStackLabel();
      sensInput.value = 4;
      updateSensLabel();
      caffSensInput.value = 3;
      updateCaffSensLabel();
      // Set sweet to medium, portion to restaurant, time to evening
      ["sweetGroup", "portionGroup", "todGroup", "caffTypeGroup"].forEach(
        (id) => {
          const group = document.getElementById(id);
          if (!group) return;
          [...group.querySelectorAll(".pill")].forEach((p) =>
            p.classList.remove("selected")
          );
        }
      );
      document
        .querySelector('#sweetGroup .pill[data-sweet="medium"]')
        .classList.add("selected");
      document
        .querySelector('#portionGroup .pill[data-portion="restaurant"]')
        .classList.add("selected");
      document
        .querySelector('#todGroup .pill[data-tod="evening"]')
        .classList.add("selected");
      document
        .querySelector('#caffTypeGroup .pill[data-caff="none"]')
        .classList.add("selected");

      const input = buildInputFromSimple();
      const result = computeAnxietyRisk(input);
      lastResult = result;
      renderResult(result);
      addToHistory(result);
    });

    whyNowBtn.addEventListener("click", () => {
      if (!lastResult) {
        whyNowOutput.textContent =
          "Run a prediction for your last meal first, then this can tell you where you are on that curve.";
        return;
      }
      const mins = parseFloat(minutesSinceInput.value);
      if (isNaN(mins) || mins < 0) {
        whyNowOutput.textContent =
          "Enter how many minutes it has been since the meal that might be causing this.";
        return;
      }

      const { spikeMin, spikeMax, crashMin, crashMax } = lastResult;
      let zone = "";
      let message = "";

      if (mins < spikeMin) {
        zone = "Pre spike";
        message =
          "You are before the main spike. If you feel anxious now, it may be more related to baseline tension or something earlier today.";
      } else if (mins >= spikeMin && mins <= spikeMax) {
        zone = "Spike zone";
        message =
          "You are in the spike zone. Some people feel wired, restless or a little buzzy here, especially with caffeine.";
      } else if (mins > spikeMax && mins < crashMin) {
        zone = "Between spike and crash";
        message =
          "You are between spike and crash. This is a transition period. Some people feel normal here, some start to feel a shift.";
      } else if (mins >= crashMin && mins <= crashMax) {
        zone = "Crash and anxiety window";
        message =
          "You are right in the predicted crash and anxiety window. This is the most likely time for carb and sugar biology to feel like anxiety. The wave usually eases on its own as you move past this window.";
      } else if (mins > crashMax && mins <= crashMax + 60) {
        zone = "Recovery zone";
        message =
          "You are past the main crash window. You may feel tired, a bit flat or simply relieved. Biology is settling down.";
      } else {
        zone = "Likely not from this meal";
        message =
          "You are far past the predicted crash window. Any anxiety now is probably not driven mainly by this particular meal.";
      }

      whyNowOutput.innerHTML = `
        <div><strong>Zone:</strong> ${zone}</div>
        <div class="small" style="margin-top:4px;">${message}</div>
      `;
    });
  </script>
</body>
</html>
