<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Body Rhythm Console - Beta</title>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      background: #05060a;
      color: #f2f2f7;
      display: flex;
      height: 100vh;
    }
    .console {
      margin: auto;
      width: min(1150px, 95vw);
      height: min(720px, 92vh);
      border-radius: 24px;
      border: 2px solid #313446;
      display: grid;
      grid-template-columns: 2fr 1fr;
      background: radial-gradient(circle at top, #22263a 0, #090b13 40%, #05060a 80%);
      box-shadow: 0 22px 45px rgba(0,0,0,0.8);
      overflow: hidden;
    }

    /* Chat side */
    .chat {
      border-right: 1px solid #26293a;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }
    .chat-header {
      padding: 10px 14px;
      border-bottom: 1px solid #26293a;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: #9ba2ff;
      background: linear-gradient(to right, rgba(60,68,120,0.5), transparent);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .chat-messages {
      flex: 1;
      padding: 14px;
      overflow-y: auto;
      font-size: 14px;
    }
    .chat-msg {
      margin-bottom: 8px;
      line-height: 1.5;
    }
    .chat-msg strong {
      color: #d4d7ff;
    }
    .chat-input {
      display: flex;
      border-top: 1px solid #26293a;
    }
    .chat-input input {
      flex: 1;
      border: none;
      padding: 10px;
      background: #121522;
      color: #f2f2f7;
      outline: none;
      font-size: 14px;
    }
    .chat-input button {
      border: none;
      padding: 10px 16px;
      background: #2f7df6;
      color: white;
      font-size: 14px;
      cursor: pointer;
      border-radius: 0;
      white-space: nowrap;
    }
    .chat-input button:active {
      transform: translateY(1px);
    }

    /* Control side */
    .controls {
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow-y: auto;
      min-width: 0;
    }
    .panel {
      background: rgba(10,12,22,0.95);
      border-radius: 14px;
      padding: 10px 10px 12px 10px;
      border: 1px solid #2a3043;
    }
    .panel h3 {
      margin: 0 0 6px 0;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #a7b0ff;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .btn {
      flex: 1;
      min-width: 90px;
      padding: 6px 8px;
      font-size: 11px;
      border-radius: 999px;
      border: 1px solid #3a4058;
      background: #191e30;
      color: #f2f2f7;
      cursor: pointer;
      text-align: center;
    }
    .btn:active {
      transform: translateY(1px);
    }

    /* Mode toggle */
    .mode-row {
      display: flex;
      gap: 6px;
    }
    .mode-btn {
      flex: 1;
      padding: 6px 8px;
      font-size: 11px;
      border-radius: 999px;
      border: 1px solid #3a4058;
      background: #151829;
      color: #c4c8ef;
      cursor: pointer;
      text-align: center;
    }
    .mode-btn.active {
      background: #2f7df6;
      border-color: #4f8dff;
      color: #ffffff;
    }

    .slider-group {
      display: flex;
      flex-direction: column;
      gap: 3px;
      font-size: 12px;
      margin-bottom: 8px;
    }
    .slider-group label {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: #b3b7d2;
    }

    /* Bigger sliders for iPad */
    input[type="range"] {
      width: 100%;
      height: 26px;
      cursor: pointer;
      background: transparent;
    }
    input[type="range"]::-webkit-slider-runnable-track {
      height: 6px;
      background: #2b3147;
      border-radius: 3px;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #2f7df6;
      border: 2px solid #ffffff33;
      margin-top: -7px;
    }
    input[type="range"]:focus {
      outline: none;
    }

    .mini-label {
      font-size: 10px;
      color: #7e84a8;
      margin-top: 2px;
    }

    .time-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 4px 8px;
      font-size: 11px;
    }
    .time-grid label {
      display: flex;
      flex-direction: column;
      gap: 2px;
      color: #c1c6e3;
    }
    .time-grid input[type="time"],
    .time-grid select,
    .time-grid textarea {
      background: #151829;
      border: 1px solid #303651;
      border-radius: 6px;
      padding: 3px 4px;
      color: #f2f2f7;
      font-size: 11px;
      outline: none;
    }
    .time-grid textarea {
      resize: vertical;
      min-height: 40px;
    }
    .full-span {
      grid-column: 1 / -1;
    }

    .tag-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 4px;
    }
    .tag {
      font-size: 10px;
      border-radius: 999px;
      padding: 3px 6px;
      border: 1px solid #333a5b;
      color: #aab0d5;
    }

    .history-list {
      list-style: none;
      padding: 0;
      margin: 4px 0 0 0;
      font-size: 11px;
      color: #c5c9e5;
    }
    .history-list li {
      margin-bottom: 4px;
    }
    .history-label {
      font-weight: 600;
    }

    ::-webkit-scrollbar {
      width: 6px;
    }
    ::-webkit-scrollbar-track {
      background: #090b13;
    }
    ::-webkit-scrollbar-thumb {
      background: #2d3145;
      border-radius: 3px;
    }

    @media (max-width: 800px) {
      .console {
        grid-template-columns: 1fr;
        height: auto;
      }
      .chat {
        border-right: none;
        border-bottom: 1px solid #26293a;
      }
    }
  </style>
</head>
<body>
  <div class="console">
    <!-- Chat side -->
    <div class="chat">
      <div class="chat-header">Body Rhythm Console · Beta</div>
      <div class="chat-messages" id="chatMessages">
        <div class="chat-msg">
          <strong>App:</strong> Welcome. This console helps you understand how your body actually works. Not through diets or diagnoses, but through timing, stress load, and your gut–brain rhythm.
        </div>
        <div class="chat-msg">
          <strong>App:</strong> Most long term IBS-like issues and anxiety driven physical symptoms follow patterns that no one ever maps. This tool helps you find your personal rhythm so your mornings become more predictable and your nervous system stays calmer.
        </div>
        <div class="chat-msg">
          <strong>App:</strong> Use the sliders to describe how you feel, set tonight’s timing, and then log and explore. You are not broken, you just have a pattern that has not been visible yet.
        </div>
      </div>
      <div class="chat-input">
        <input id="chatInput" placeholder="Type a note or question (optional, not wired to real AI yet)...">
        <button onclick="sendChat()">Send</button>
      </div>
    </div>
        <!-- Controls side -->
    <div class="controls">
      <!-- Mode toggle -->
      <div class="panel">
        <h3>Mode</h3>
        <div class="mode-row">
          <button class="mode-btn active" id="modeIbs" onclick="setMode('ibs')">IBS / Morning rhythm</button>
          <button class="mode-btn" id="modeAnx" onclick="setMode('anx')">Anxiety / Crash timing</button>
        </div>
        <p class="mini-label">
          IBS / Morning rhythm: evening timing and morning bathroom pattern.
          <br>
          Anxiety / Crash timing: sugar, caffeine, sleep, and crash windows.
        </p>
      </div>

      <!-- IBS panel -->
      <div id="ibsPanel">
        <!-- Step 1 -->
        <div class="panel">
          <h3>Step 1 · How do you feel right now?</h3>
          <div class="slider-group">
            <label>
              <span>Stress</span>
              <span id="stressVal">2/10</span>
            </label>
            <input type="range" id="stress" min="0" max="10" value="2" oninput="updateLabel('stress')">
          </div>
          <div class="slider-group">
            <label>
              <span>Shoulder tension</span>
              <span id="shoulderVal">3/10</span>
            </label>
            <input type="range" id="shoulder" min="0" max="10" value="3" oninput="updateLabel('shoulder')">
          </div>
          <div class="slider-group">
            <label>
              <span>Gut comfort</span>
              <span id="gutVal">6/10</span>
            </label>
            <input type="range" id="gut" min="0" max="10" value="6" oninput="updateLabel('gut')">
          </div>
          <div class="slider-group">
            <label>
              <span>Anxiety level</span>
              <span id="anxVal">3/10</span>
            </label>
            <input type="range" id="anx" min="0" max="10" value="3" oninput="updateLabel('anx')">
          </div>
          <p class="mini-label">
            Set these to match how your body and nervous system feel right now.
          </p>
        </div>

        <!-- Step 2 -->
        <div class="panel">
          <h3>Step 2 · Tonight's timing</h3>
          <div class="time-grid">
            <label>
              Dinner
              <input type="time" id="dinTime" value="19:00">
            </label>
            <label>
              Last food
              <input type="time" id="foodTime" value="19:45">
            </label>
            <label>
              Last drink
              <input type="time" id="drinkTime" value="21:30">
            </label>
            <label>
              Magnesium glycinate
              <input type="time" id="magTime" value="23:00">
            </label>
            <label>
              Sleep
              <input type="time" id="sleepTime" value="00:30">
            </label>
            <label>
              Wake
              <input type="time" id="wakeTime" value="08:00">
            </label>
            <label class="full-span">
              Last meal eaten
              <textarea id="ibsMeal" style="min-height:32px;"
                placeholder="Chicken and rice, cereal + banana, salad, pizza..."></textarea>
            </label>
          </div>
          <p class="mini-label">
            Keep it simple. You do not need grams, just a quick description of the last plate.
          </p>
        </div>

        <!-- Step 3 -->
        <div class="panel">
          <h3>Step 3 · What do you want to do?</h3>
          <div class="btn-row">
            <button class="btn" onclick="preset('log_today')">Save today to history</button>
            <button class="btn" onclick="preset('insight')">Show me today’s pattern</button>
            <button class="btn" onclick="preset('forecast')">Predict tomorrow morning</button>
          </div>
          <div class="btn-row" style="margin-top:4px;">
            <button class="btn" onclick="preset('explain')">Explain my system</button>
            <button class="btn" onclick="preset('driving')">What is driving today?</button>
            <button class="btn" onclick="preset('questions')">Ask me questions</button>
          </div>
        </div>

        <!-- Step 4 -->
        <div class="panel">
          <h3>Step 4 · Morning outcome</h3>
          <div class="time-grid">
            <label>
              BM time
              <input type="time" id="bmTime" value="08:05">
            </label>
            <label>
              Pain level
              <input type="range" id="bmPain" min="0" max="10" value="2" oninput="updateLabel('pain')">
              <span id="bmPainVal" style="font-size:10px;color:#b3b7d2;">2/10</span>
            </label>
            <label>
              Bristol form
              <select id="bmForm">
                <option value="1">1 · Separate hard lumps</option>
                <option value="2">2 · Lumpy sausage</option>
                <option value="3">3 · Cracked sausage</option>
                <option value="4" selected>4 · Smooth, soft sausage</option>
                <option value="5">5 · Soft blobs, clear edges</option>
                <option value="6">6 · Fluffy, mushy</option>
                <option value="7">7 · Watery, no solids</option>
              </select>
            </label>
          </div>
          <p class="mini-label">
            This is what actually happened in the morning. Later, this feeds into pattern detection so you can see how last night’s timing and state match your outcomes.
          </p>
        </div>

        <!-- Recent days -->
        <div class="panel">
          <h3>Recent days</h3>
          <ul id="historyList" class="history-list"></ul>
          <p class="mini-label">
            These are quick summaries saved on this device only. They show how your last few evenings and mornings fit into stable, sensitive, or in between patterns.
          </p>
        </div>
      </div>
            <!-- Anxiety panel -->
      <div id="anxPanel" style="display:none;">
        <div class="panel">
          <h3>Anxiety quick actions</h3>
          <div class="btn-row">
            <button class="btn" onclick="anxAction('log')">Log anxiety day</button>
            <button class="btn" onclick="anxAction('forecast')">Show spike / crash time</button>
          </div>
          <div class="btn-row" style="margin-top:4px;">
            <button class="btn" onclick="anxAction('explain')">Explain today</button>
            <button class="btn" onclick="anxAction('questions')">Ask me questions</button>
          </div>
        </div>

        <div class="panel">
          <h3>Anxiety day inputs</h3>
          <div class="time-grid">
            <label>
              Main carb / sugar hit
              <input type="time" id="anxHitTime" value="14:00">
            </label>
            <label>
              Sugar / carb load
              <input type="range" id="anxSugar" min="0" max="10" value="5" oninput="updateAnxLabel('sugar')">
              <span id="anxSugarVal" style="font-size:10px;color:#b3b7d2;">5/10</span>
            </label>
            <label>
              Caffeine today
              <input type="range" id="anxCaf" min="0" max="10" value="2" oninput="updateAnxLabel('caf')">
              <span id="anxCafVal" style="font-size:10px;color:#b3b7d2;">2/10</span>
            </label>
            <label>
              Sleep quality
              <input type="range" id="anxSleep" min="0" max="10" value="6" oninput="updateAnxLabel('sleep')">
              <span id="anxSleepVal" style="font-size:10px;color:#b3b7d2;">6/10</span>
            </label>
            <label>
              Baseline sensitivity
              <input type="range" id="anxSens" min="0" max="10" value="5" oninput="updateAnxLabel('sens')">
              <span id="anxSensVal" style="font-size:10px;color:#b3b7d2;">5/10</span>
            </label>
            <label class="full-span">
              Foods and notes
              <textarea id="anxFoods" placeholder="Small bowl of cereal, 2 cookies, soda before bed, etc..."></textarea>
            </label>
          </div>
          <p class="mini-label">
            In the full version, this foods box will feed the AI so it can estimate how heavy the sugar / carb load was and fold it into the spike and crash timing.
          </p>
        </div>
      </div>
    </div>
  </div>
    <script>
    const HISTORY_KEY = 'brcHistory_v1';
    let currentMode = 'ibs';

    function setMode(mode) {
      currentMode = mode;
      const ibsPanel = document.getElementById('ibsPanel');
      const anxPanel = document.getElementById('anxPanel');
      const modeIbs = document.getElementById('modeIbs');
      const modeAnx = document.getElementById('modeAnx');

      if (mode === 'ibs') {
        ibsPanel.style.display = '';
        anxPanel.style.display = 'none';
        modeIbs.classList.add('active');
        modeAnx.classList.remove('active');
      } else {
        ibsPanel.style.display = 'none';
        anxPanel.style.display = '';
        modeAnx.classList.add('active');
        modeIbs.classList.remove('active');
      }
    }

    function addMessage(sender, text) {
      const box = document.getElementById('chatMessages');
      const div = document.createElement('div');
      div.className = 'chat-msg';
      div.innerHTML = `<strong>${sender}:</strong> ${text}`;
      box.appendChild(div);
      box.scrollTop = box.scrollHeight;
    }

    function sendChat() {
      const input = document.getElementById('chatInput');
      const text = input.value.trim();
      if (!text) return;
      addMessage('You', text);
      input.value = '';
      setTimeout(() => {
        addMessage('App', 'In the full version this text would be interpreted alongside your sliders, timing, and outcome so the system can learn your patterns.');
      }, 400);
    }

    function updateLabel(which) {
      if (which === 'stress') {
        const v = document.getElementById('stress').value;
        document.getElementById('stressVal').textContent = `${v}/10`;
      }
      if (which === 'shoulder') {
        const v = document.getElementById('shoulder').value;
        document.getElementById('shoulderVal').textContent = `${v}/10`;
      }
      if (which === 'gut') {
        const v = document.getElementById('gut').value;
        document.getElementById('gutVal').textContent = `${v}/10`;
      }
      if (which === 'anx') {
        const v = document.getElementById('anx').value;
        document.getElementById('anxVal').textContent = `${v}/10`;
      }
      if (which === 'pain') {
        const v = document.getElementById('bmPain').value;
        document.getElementById('bmPainVal').textContent = `${v}/10`;
      }
    }

    function updateAnxLabel(which) {
      if (which === 'sugar') {
        const v = document.getElementById('anxSugar').value;
        document.getElementById('anxSugarVal').textContent = `${v}/10`;
      }
      if (which === 'caf') {
        const v = document.getElementById('anxCaf').value;
        document.getElementById('anxCafVal').textContent = `${v}/10`;
      }
      if (which === 'sleep') {
        const v = document.getElementById('anxSleep').value;
        document.getElementById('anxSleepVal').textContent = `${v}/10`;
      }
      if (which === 'sens') {
        const v = document.getElementById('anxSens').value;
        document.getElementById('anxSensVal').textContent = `${v}/10`;
      }
    }

    function timeToMinutes(id) {
      const t = document.getElementById(id).value;
      if (!t) return null;
      const [h, m] = t.split(':').map(Number);
      return h * 60 + m;
    }

    function minutesToClockString(mins) {
      if (mins == null) return '';
      let m = mins % (24 * 60);
      if (m < 0) m += 24 * 60;
      const hour = Math.floor(m / 60);
      const minute = m % 60;
      const ampm = hour >= 12 ? 'pm' : 'am';
      const hour12 = ((hour + 11) % 12) + 1;
      const minuteStr = minute.toString().padStart(2, '0');
      return `${hour12}:${minuteStr} ${ampm}`;
    }

    function loadHistory() {
      try {
        const raw = localStorage.getItem(HISTORY_KEY);
        if (!raw) return [];
        const data = JSON.parse(raw);
        return Array.isArray(data) ? data : [];
      } catch {
        return [];
      }
    }

    function saveHistory(list) {
      localStorage.setItem(HISTORY_KEY, JSON.stringify(list));
    }

    function renderHistory() {
      const list = loadHistory();
      const ul = document.getElementById('historyList');
      ul.innerHTML = '';
      if (!list.length) {
        const li = document.createElement('li');
        li.textContent = 'No days logged yet.';
        ul.appendChild(li);
        return;
      }
      list.slice(-7).reverse().forEach(entry => {
        const li = document.createElement('li');
        li.innerHTML = `<span class="history-label">${entry.dayLabel}</span> · ${entry.label} · driver: ${entry.driver}`;
        ul.appendChild(li);
      });
    }

    function classifyDay(info) {
      const { drinkGap, stress, anx, shoulder, gut, bmForm, bmPain } = info;

      let label = 'Recovery / mixed';

      if (
        drinkGap != null && drinkGap >= 90 &&
        stress <= 4 && anx <= 4 &&
        shoulder <= 5 &&
        gut >= 6 &&
        bmPain <= 2 &&
        bmForm >= 3 && bmForm <= 5
      ) {
        label = 'Stable';
      } else if (
        bmForm >= 6 ||
        bmPain >= 5 ||
        (drinkGap != null && drinkGap < 60) ||
        stress >= 7 ||
        anx >= 7
      ) {
        label = 'Sensitive';
      }

      const drivers = [];
      if (drinkGap != null && drinkGap < 75) drivers.push('late/tight last drink to magnesium glycinate gap');
      if (stress >= 6) drivers.push('high stress');
      if (anx >= 6) drivers.push('high anxiety');
      if (shoulder >= 6) drivers.push('shoulder/neck tension');
      if (bmForm >= 6) drivers.push('soft/watery form');
      if (bmPain >= 5) drivers.push('higher pain');

      const driver = drivers[0] || 'no single dominant factor';

      return { label, driver };
    }

    /* IBS actions */
    function preset(type) {
      const stress = +document.getElementById('stress').value;
      const shoulder = +document.getElementById('shoulder').value;
      const gut = +document.getElementById('gut').value;
      const anx = +document.getElementById('anx').value;

      const tDinner = timeToMinutes('dinTime');
      const tFood = timeToMinutes('foodTime');
      const tDrink = timeToMinutes('drinkTime');
      const tMag = timeToMinutes('magTime');
      const tSleep = timeToMinutes('sleepTime');
      const tWake = timeToMinutes('wakeTime');

      const tBm = timeToMinutes('bmTime');
      const bmForm = +document.getElementById('bmForm').value;
      const bmPain = +document.getElementById('bmPain').value;

      const ibsMeal = document.getElementById('ibsMeal').value.trim();

      const drinkGap = tMag != null && tDrink != null ? tMag - tDrink : null;
      const foodGap = tSleep != null && tFood != null ? tSleep - tFood : null;

      if (type === 'log_today') {
        let summary = `Save today: stress=${stress}, shoulder=${shoulder}, gut=${gut}, anxiety=${anx}, BM form=${bmForm}, BM pain=${bmPain}.`;
        addMessage('You', summary);
        if (ibsMeal) {
          addMessage('You', `Last meal: ${ibsMeal}`);
        }

        const classification = classifyDay({
          drinkGap,
          stress,
          anx,
          shoulder,
          gut,
          bmForm,
          bmPain
        });

        const today = new Date();
        const dayLabel = today.toLocaleDateString(undefined, {
          weekday: 'short',
          month: 'numeric',
          day: 'numeric'
        });

        const history = loadHistory();
        history.push({
          dayLabel,
          label: classification.label,
          driver: classification.driver
        });
        const trimmed = history.slice(-30);
        saveHistory(trimmed);
        renderHistory();

        // Short glance line
        addMessage(
          'App',
          `Today at a glance: ${classification.label} day, main driver: ${classification.driver}.`
        );

        addMessage(
          'App',
          `Logged as a "${classification.label}" day with main driver: ${classification.driver}. In a full build this history would be used to refine your personal rhythm model over time.`
        );
      }

      if (type === 'insight') {
        addMessage('You', 'Show me today’s pattern.');
        let msg;

        if (drinkGap !== null && drinkGap < 75) {
          msg = 'Your last drink is fairly close to magnesium glycinate. On systems like yours, mornings tend to be softer or more unpredictable when the gap is under about 75 to 90 minutes.';
        } else if (shoulder >= 7) {
          msg = 'Shoulder tension is high. On days like this, splenic flexure and left side sensitivity often show up even if digestion itself is fine. This is more nervous system than gut tissue.';
        } else if (anx >= 6 && stress >= 6) {
          msg = 'Both stress and anxiety are elevated. That usually raises your internal volume knob and makes normal sensations feel louder, even when timing is decent.';
        } else if (gut >= 7 && stress <= 3 && (drinkGap === null || drinkGap >= 90)) {
          msg = 'This looks close to your stable rhythm: decent gut comfort, low stress, and a solid gap between last drink and magnesium glycinate. That is usually a strong setup for a predictable morning.';
        } else {
          msg = 'Today looks mixed. Nothing screams disaster, but sensitivity is a bit elevated. Small improvements in cutoff or evening calm will likely pay off tomorrow.';
        }

        if (tBm != null) {
          if (bmForm >= 6) {
            msg += ' This morning’s form suggests your system is still on the softer side. Often that tracks back to either a tight last drink to magnesium glycinate gap or more nervous system load than ideal.';
          } else if (bmForm === 4 && bmPain <= 2) {
            msg += ' The morning outcome you logged (smooth form and low pain) fits your more stable pattern, which is a good sign that your timing is on the right track.';
          }
        }

        addMessage('App', msg);
      }

      if (type === 'forecast') {
        addMessage('You', 'Predict tomorrow morning.');

        let msg = 'Given this setup, tomorrow looks like a sensitive but workable morning. Not perfect, not terrible. Expect more awareness than true pain.';

        if (drinkGap !== null && drinkGap >= 90 && stress <= 3 && anx <= 3 && shoulder <= 4 && gut >= 6) {
          msg = 'This is one of your stronger setups. I would expect a single mostly solid morning BM, low pain, and a quieter nervous system overall.';
        } else if (drinkGap !== null && drinkGap < 60) {
          msg = 'Tomorrow has a higher chance of a soft or partly watery morning, mostly due to the tight last drink to magnesium glycinate gap. Not dangerous, just less stable.';
        } else if (anx >= 7 || stress >= 7) {
          msg = 'Tomorrow may feel louder in your body even if the gut behaves. Expect more internal noise, mostly driven by nervous system state rather than true gut trouble.';
        }

        addMessage('App', msg);
      }

      if (type === 'explain') {
        addMessage('You', 'Explain my system.');
        const msg =
          'You have a timing sensitive, nervous system heavy pattern. Evenings with calmer stress, lower shoulder tension, and a clear cutoff between last drink and magnesium glycinate usually give you stable mornings. When stress, anxiety, or shoulder tension run high, your sensitivity goes up even if nothing is “wrong” in the gut itself.';
        addMessage('App', msg);
      }

      if (type === 'driving') {
        addMessage('You', 'What is driving today?');
        let drivers = [];

        if (drinkGap !== null && drinkGap < 75) drivers.push('tight last drink to magnesium glycinate gap');
        if (shoulder >= 6) drivers.push('shoulder and neck tension');
        if (anx >= 6) drivers.push('anxiety level');
        if (stress >= 6) drivers.push('overall stress load');

        if (drivers.length === 0) {
          addMessage(
            'App',
            'Nothing is screaming as a strong driver today from the sliders alone. This looks more like a fine tune and watch what happens kind of day rather than a clear trigger day.'
          );
        } else {
          addMessage(
            'App',
            `The main drivers tonight look like: ${drivers.join(', ')}. Those are the knobs that usually change your sensitivity the most.`
          );
        }
      }

      if (type === 'questions') {
        addMessage('You', 'Ask me some narrowing questions.');

        const qs = [];

        if (drinkGap !== null && drinkGap < 75) {
          qs.push('Your last drink is fairly close to magnesium glycinate. On nights like this, have your worst or softest mornings usually happened, or does it still feel random to you?');
        }
        if (shoulder >= 7) {
          qs.push('With shoulder tension this high, do you usually notice more left side gut awareness or splenic flexure style pressure either that night or the next morning?');
        }
        if (anx >= 6) {
          qs.push('When anxiety is this elevated, do you tend to feel the anxiety first and then the gut reacts, or does the gut flare first and your mind responds after?');
        }
        if (stress >= 6 && anx < 6) {
          qs.push('Stress is high but anxiety is a bit lower. Does your body hold this mostly in muscle tension (shoulders, neck, jaw), or does your gut often join in too on days like this?');
        }
        if (gut <= 4) {
          qs.push('Gut comfort is low. Would you describe it more as sharp pain, pressure, bloating, or just hypersensitive awareness where everything inside feels too loud?');
        }

        if (!qs.length) {
          qs.push('Nothing jumps out as a clear driver from the sliders alone. If you had to guess, what part of today feels most off: timing, stress, sleep, or body tension?');
        }

        qs.forEach(q => addMessage('App', q));
      }
    }

    /* Anxiety actions */
    function anxAction(type) {
      const sugar = +document.getElementById('anxSugar').value;
      const caf = +document.getElementById('anxCaf').value;
      const sleep = +document.getElementById('anxSleep').value;
      const sens = +document.getElementById('anxSens').value;
      const foods = document.getElementById('anxFoods').value.trim();
      const hitTime = timeToMinutes('anxHitTime');

      if (type === 'log') {
        addMessage('You', `Log anxiety day: sugar=${sugar}/10, caffeine=${caf}/10, sleep=${sleep}/10, baseline sensitivity=${sens}/10.`);
        if (foods) {
          addMessage('You', `Foods / notes: ${foods}`);
        }
        addMessage('App', 'Logged this anxiety day. In a full build this would be stored along with your IBS timing so both rhythms can be compared side by side.');
      }

      if (type === 'forecast') {
        addMessage('You', 'Show spike / crash time.');

        // Basic risk score
        let score = 0;
        if (sugar >= 6) score++;
        if (caf >= 5) score++;
        if (sleep <= 4) score++;
        if (sens >= 7) score++;

        let risk = 'Low';
        if (score === 2) risk = 'Moderate';
        if (score >= 3) risk = 'High';

        // Main driver
        let driver = 'mixed factors';
        if (sugar >= 7 && caf >= 5) {
          driver = 'big sugar plus caffeine load';
        } else if (sugar >= 6 && caf <= 3) {
          driver = 'heavier carbs with low caffeine';
        } else if (sugar <= 3 && caf >= 7) {
          driver = 'caffeine more than sugar';
        } else if (sleep <= 4 && sens >= 7) {
          driver = 'thin sleep and high sensitivity';
        }

        let spikeStart = null;
        let spikeEnd = null;
        let crashStart = null;
        let crashEnd = null;

        if (hitTime != null) {
          // Shape the windows based on sugar and caffeine
          if (sugar >= 7 && caf >= 5) {
            spikeStart = hitTime + 30;
            spikeEnd = hitTime + 90;
            crashStart = hitTime + 120;
            crashEnd = hitTime + 240;
          } else if (sugar >= 6 && caf <= 3) {
            spikeStart = hitTime + 60;
            spikeEnd = hitTime + 120;
            crashStart = hitTime + 180;
            crashEnd = hitTime + 300;
          } else if (sugar <= 3 && caf >= 7) {
            spikeStart = hitTime + 30;
            spikeEnd = hitTime + 90;
            crashStart = hitTime + 180;
            crashEnd = hitTime + 300;
          } else {
            spikeStart = hitTime + 60;
            spikeEnd = hitTime + 150;
            crashStart = hitTime + 180;
            crashEnd = hitTime + 300;
          }
        }

        let msg = `Crash risk: ${risk}.`;

        if (hitTime != null && spikeStart != null && crashStart != null) {
          const spikeWindow = `${minutesToClockString(spikeStart)} to ${minutesToClockString(spikeEnd)}`;
          const crashWindow = `${minutesToClockString(crashStart)} to ${minutesToClockString(crashEnd)}`;
          msg += ` Spike window: ${spikeWindow}. Crash window: ${crashWindow}.`;
        } else {
          msg += ' Add a main carb or sugar time to see a more precise spike and crash window.';
        }

        msg += ` Main driver: ${driver}.`;

        if (foods) {
          msg += ` In the full AI version, the app will also read your foods note to estimate the actual sugar and carb load from: "${foods}".`;
        }

        if (sleep <= 4 || sens >= 7) {
          msg += ' Because sleep was rough or sensitivity is high, whatever lands in that crash window is likely to feel louder than it really is.';
        }

        addMessage('App', msg);

        // Plain "what this means" line
        let meaning;
        if (risk === 'High') {
          meaning = 'wired then flat kind of day. Expect more body noise in the crash window than usual.';
        } else if (risk === 'Moderate') {
          meaning = 'mild spike then drift-down day. You may feel a bit off in the crash window but not wrecked.';
        } else {
          meaning = 'low crash risk day. Small waves more than a real crash.';
        }
        addMessage('App', `What this means: ${meaning}`);
      }

      if (type === 'explain') {
        addMessage('You', 'Explain today on the anxiety side.');
        let msg =
          'Today’s anxiety pattern is being driven by timing and load rather than something random. Sugar/carbs, caffeine, sleep quality, and your baseline sensitivity are all feeding the same nervous system.';

        if (sugar >= 7) {
          msg += ' The sugar/carb load is high enough that your body will likely do a spike then correction, which your nervous system often reads as unease or anxiety.';
        } else if (sugar <= 3) {
          msg += ' Sugar and carbs are not major triggers today, so your anxiety is more likely tied to caffeine, sleep, or baseline sensitivity.';
        }

        if (caf >= 6) {
          msg += ' Caffeine is strong enough that it probably raised your internal volume knob on its own.';
        }

        if (sleep <= 4) {
          msg += ' Short or poor sleep lowers your buffer, so any small fluctuation feels bigger.';
        }

        if (sens >= 7) {
          msg += ' A high baseline sensitivity means your nervous system is already closer to the edge, so even normal shifts can feel like something is wrong.';
        }

        addMessage('App', msg);
      }

      if (type === 'questions') {
        addMessage('You', 'Ask me some narrowing questions on the anxiety side.');
        const qs = [];

        if (sugar >= 6) {
          qs.push('On days with this much sugar or carbs, do you usually notice a clear “good for a bit then wired or anxious then flat” pattern, or is it more subtle for you?');
        }
        if (caf >= 5) {
          qs.push('When caffeine is this high, do you tend to feel the mental anxiety first or the body sensations first (heart, chest, jitter, spacey)?');
        }
        if (sleep <= 4) {
          qs.push('With sleep this low, do you usually feel more fragile all day, or does it mostly show up in certain windows like mid afternoon or late at night?');
        }
        if (sens >= 7) {
          qs.push('When your baseline sensitivity is this high, do gut sensations and anxiety usually trade places like they do for you on IBS heavy days, or do they stack together?');
        }

        if (!qs.length) {
          qs.push('Nothing jumps out as a single obvious driver. If you had to pick one, does today feel more driven by sugar timing, caffeine, sleep, or just overall stress load?');
        }

        qs.forEach(q => addMessage('App', q));
      }
    }

    // initial history render
    renderHistory();
  </script>
</body>
</html>
