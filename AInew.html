<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Body Rhythm Console - Beta</title>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      background: #05060a;
      color: #f2f2f7;
      display: flex;
      height: 100vh;
    }
    .console {
      margin: auto;
      width: min(1150px, 95vw);
      height: min(720px, 92vh);
      border-radius: 24px;
      border: 2px solid #313446;
      display: grid;
      grid-template-columns: 2fr 1fr;
      background: radial-gradient(circle at top, #22263a 0, #090b13 40%, #05060a 80%);
      box-shadow: 0 22px 45px rgba(0,0,0,0.8);
      overflow: hidden;
    }

    /* Chat side */
    .chat {
      border-right: 1px solid #26293a;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }
    .chat-header {
      padding: 10px 14px;
      border-bottom: 1px solid #26293a;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: #9ba2ff;
      background: linear-gradient(to right, rgba(60,68,120,0.5), transparent);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .chat-messages {
      flex: 1;
      padding: 14px;
      overflow-y: auto;
      font-size: 14px;
    }
    .chat-msg {
      margin-bottom: 8px;
      line-height: 1.5;
    }
    .chat-msg strong {
      color: #d4d7ff;
    }
    .chat-input {
      display: flex;
      border-top: 1px solid #26293a;
    }
    .chat-input input {
      flex: 1;
      border: none;
      padding: 10px;
      background: #121522;
      color: #f2f2f7;
      outline: none;
      font-size: 14px;
    }
    .chat-input button {
      border: none;
      padding: 10px 16px;
      background: #2f7df6;
      color: white;
      font-size: 14px;
      cursor: pointer;
      border-radius: 0;
      white-space: nowrap;
    }
    .chat-input button:active {
      transform: translateY(1px);
    }

    /* Control side */
    .controls {
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow-y: auto;
      min-width: 0;
    }
    .panel {
      background: rgba(10,12,22,0.95);
      border-radius: 14px;
      padding: 10px 10px 12px 10px;
      border: 1px solid #2a3043;
    }
    .panel h3 {
      margin: 0 0 6px 0;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #a7b0ff;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .btn {
      flex: 1;
      min-width: 90px;
      padding: 6px 8px;
      font-size: 11px;
      border-radius: 999px;
      border: 1px solid #3a4058;
      background: #191e30;
      color: #f2f2f7;
      cursor: pointer;
      text-align: center;
    }
    .btn:active {
      transform: translateY(1px);
    }

    /* Mode toggle */
    .mode-row {
      display: flex;
      gap: 6px;
    }
    .mode-btn {
      flex: 1;
      padding: 6px 8px;
      font-size: 11px;
      border-radius: 999px;
      border: 1px solid #3a4058;
      background: #151829;
      color: #c4c8ef;
      cursor: pointer;
      text-align: center;
    }
    .mode-btn.active {
      background: #2f7df6;
      border-color: #4f8dff;
      color: #ffffff;
    }

    .slider-group {
      display: flex;
      flex-direction: column;
      gap: 3px;
      font-size: 12px;
      margin-bottom: 8px;
    }
    .slider-group label {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: #b3b7d2;
    }

    /* Bigger sliders for iPad */
    input[type="range"] {
      width: 100%;
      height: 26px;
      cursor: pointer;
      background: transparent;
    }
    input[type="range"]::-webkit-slider-runnable-track {
      height: 6px;
      background: #2b3147;
      border-radius: 3px;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #2f7df6;
      border: 2px solid #ffffff33;
      margin-top: -7px;
    }
    input[type="range"]:focus {
      outline: none;
    }

    .mini-label {
      font-size: 10px;
      color: #7e84a8;
      margin-top: 2px;
    }

    .time-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 4px 8px;
      font-size: 11px;
    }
    .time-grid label {
      display: flex;
      flex-direction: column;
      gap: 2px;
      color: #c1c6e3;
    }
    .time-grid input[type="time"],
    .time-grid select,
    .time-grid textarea {
      background: #151829;
      border: 1px solid #303651;
      border-radius: 6px;
      padding: 3px 4px;
      color: #f2f2f7;
      font-size: 11px;
      outline: none;
    }
    .time-grid textarea {
      resize: vertical;
      min-height: 40px;
    }
    .full-span {
      grid-column: 1 / -1;
    }

    .tag-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 4px;
    }
    .tag {
      font-size: 10px;
      border-radius: 999px;
      padding: 3px 6px;
      border: 1px solid #333a5b;
      color: #aab0d5;
    }

    .history-list {
      list-style: none;
      padding: 0;
      margin: 4px 0 0 0;
      font-size: 11px;
      color: #c5c9e5;
    }
    .history-list li {
      margin-bottom: 4px;
    }
    .history-label {
      font-weight: 600;
    }

    ::-webkit-scrollbar {
      width: 6px;
    }
    ::-webkit-scrollbar-track {
      background: #090b13;
    }
    ::-webkit-scrollbar-thumb {
      background: #2d3145;
      border-radius: 3px;
    }

    @media (max-width: 800px) {
      .console {
        grid-template-columns: 1fr;
        height: auto;
      }
      .chat {
        border-right: none;
        border-bottom: 1px solid #26293a;
      }
    }
  </style>
</head>
<body>
  <div class="console">
    <!-- Chat side -->
    <div class="chat">
      <div class="chat-header">Body Rhythm Console · Beta</div>
      <div class="chat-messages" id="chatMessages">
        <div class="chat-msg">
          <strong>App:</strong> Welcome. This console helps you understand how your body actually works. Not through diets or diagnoses, but through timing, stress load, and your gut–brain rhythm.
        </div>
        <div class="chat-msg">
          <strong>App:</strong> Most long term IBS-like issues and anxiety driven physical symptoms follow patterns that no one ever maps. This tool helps you find your personal rhythm so your mornings become more predictable and your nervous system stays calmer.
        </div>
        <div class="chat-msg">
          <strong>App:</strong> Use the sliders to describe how you feel, set tonight’s timing, and then log and explore. You are not broken, you just have a pattern that has not been visible yet.
        </div>
      </div>
      <div class="chat-input">
        <input id="chatInput" placeholder="Type a note or question (optional, not wired to real AI yet)...">
        <button onclick="sendChat()">Send</button>
      </div>
    </div>
        <!-- Controls side -->
    <div class="controls">
      <!-- Mode toggle -->
      <div class="panel">
        <h3>Mode</h3>
        <div class="mode-row">
          <button class="mode-btn active" id="modeIbs" onclick="setMode('ibs')">IBS / Morning rhythm</button>
          <button class="mode-btn" id="modeAnx" onclick="setMode('anx')">Anxiety / Crash timing</button>
        </div>
        <p class="mini-label">
          IBS / Morning rhythm: evening timing and morning bathroom pattern.
          <br>
          Anxiety / Crash timing: sugar, caffeine, sleep, and crash windows.
        </p>
      </div>

      <!-- IBS panel -->
      <div id="ibsPanel">
        <!-- Step 1 -->
        <div class="panel">
          <h3>Step 1 · How do you feel right now?</h3>
          <div class="slider-group">
            <label>
              <span>Stress</span>
              <span id="stressVal">2/10</span>
            </label>
            <input type="range" id="stress" min="0" max="10" value="2" oninput="updateLabel('stress')">
          </div>
          <div class="slider-group">
            <label>
              <span>Shoulder tension</span>
              <span id="shoulderVal">3/10</span>
            </label>
            <input type="range" id="shoulder" min="0" max="10" value="3" oninput="updateLabel('shoulder')">
          </div>
          <div class="slider-group">
            <label>
              <span>Gut comfort</span>
              <span id="gutVal">6/10</span>
            </label>
            <input type="range" id="gut" min="0" max="10" value="6" oninput="updateLabel('gut')">
          </div>
          <div class="slider-group">
            <label>
              <span>Anxiety level</span>
              <span id="anxVal">3/10</span>
            </label>
            <input type="range" id="anx" min="0" max="10" value="3" oninput="updateLabel('anx')">
          </div>
          <p class="mini-label">
            Set these to match how your body and nervous system feel right now.
          </p>
        </div>

        <!-- Step 2 -->
        <div class="panel">
          <h3>Step 2 · Tonight's timing</h3>
          <div class="time-grid">
            <label>
              Dinner
              <input type="time" id="dinTime" value="19:00">
            </label>
            <label>
              Last food
              <input type="time" id="foodTime" value="19:45">
            </label>
            <label>
              Last drink
              <input type="time" id="drinkTime" value="21:30">
            </label>
            <label>
              Magnesium glycinate
              <input type="time" id="magTime" value="23:00">
            </label>
            <label>
              Sleep
              <input type="time" id="sleepTime" value="00:30">
            </label>
            <label>
              Wake
              <input type="time" id="wakeTime" value="08:00">
            </label>
            <label class="full-span">
              Last meal eaten
              <textarea id="ibsMeal" style="min-height:32px;"
                placeholder="Chicken and rice, cereal + banana, salad, pizza..."></textarea>
            </label>
          </div>
          <p class="mini-label">
            Keep it simple. You do not need grams, just a quick description of the last plate.
          </p>
        </div>

        <!-- Step 3 -->
        <div class="panel">
          <h3>Step 3 · What do you want to do?</h3>
          <div class="btn-row">
            <button class="btn" onclick="preset('log_today')">Save today to history</button>
            <button class="btn" onclick="preset('insight')">Show me today’s pattern</button>
            <button class="btn" onclick="preset('forecast')">Predict tomorrow morning</button>
          </div>
          <div class="btn-row" style="margin-top:4px;">
            <button class="btn" onclick="preset('explain')">Explain my system</button>
            <button class="btn" onclick="preset('driving')">What is driving today?</button>
            <button class="btn" onclick="preset('questions')">Ask me questions</button>
          </div>
        </div>

        <!-- Step 4 -->
        <div class="panel">
          <h3>Step 4 · Morning outcome</h3>
          <div class="time-grid">
            <label>
              BM time
              <input type="time" id="bmTime" value="08:05">
            </label>
            <label>
              Pain level
              <input type="range" id="bmPain" min="0" max="10" value="2" oninput="updateLabel('pain')">
              <span id="bmPainVal" style="font-size:10px;color:#b3b7d2;">2/10</span>
            </label>
            <label>
              Bristol form
              <select id="bmForm">
                <option value="1">1 · Separate hard lumps</option>
                <option value="2">2 · Lumpy sausage</option>
                <option value="3">3 · Cracked sausage</option>
                <option value="4" selected>4 · Smooth, soft sausage</option>
                <option value="5">5 · Soft blobs, clear edges</option>
                <option value="6">6 · Fluffy, mushy</option>
                <option value="7">7 · Watery, no solids</option>
              </select>
            </label>
          </div>
          <p class="mini-label">
            This is what actually happened in the morning. Later, this feeds into pattern detection so you can see how last night’s timing and state match your outcomes.
          </p>
        </div>

        <!-- Recent days -->
        <div class="panel">
          <h3>Recent days</h3>
          <ul id="historyList" class="history-list"></ul>
          <p class="mini-label">
            These are quick summaries saved on this device only. They show how your last few evenings and mornings fit into stable, sensitive, or in between patterns.
          </p>
        </div>
      </div>
            <!-- Anxiety panel -->
      <div id="anxPanel" style="display:none;">
        <div class="panel">
          <h3>Anxiety quick actions</h3>
          <div class="btn-row">
            <button class="btn" onclick="anxAction('log')">Log anxiety day</button>
            <button class="btn" onclick="anxAction('forecast')">Show spike / crash time</button>
          </div>
          <div class="btn-row" style="margin-top:4px;">
            <button class="btn" onclick="anxAction('explain')">Explain today</button>
            <button class="btn" onclick="anxAction('questions')">Ask me questions</button>
          </div>
        </div>

        <div class="panel">
          <h3>Anxiety day inputs</h3>
          <div class="time-grid">
            <label>
              Main carb / sugar hit
              <input type="time" id="anxHitTime" value="14:00">
            </label>
            <label>
              Sugar / carb load
              <input type="range" id="anxSugar" min="0" max="10" value="5" oninput="updateAnxLabel('sugar')">
              <span id="anxSugarVal" style="font-size:10px;color:#b3b7d2;">5/10</span>
            </label>
            <label>
              Caffeine today
              <input type="range" id="anxCaf" min="0" max="10" value="2" oninput="updateAnxLabel('caf')">
              <span id="anxCafVal" style="font-size:10px;color:#b3b7d2;">2/10</span>
            </label>
            <label>
              Sleep quality
              <input type="range" id="anxSleep" min="0" max="10" value="6" oninput="updateAnxLabel('sleep')">
              <span id="anxSleepVal" style="font-size:10px;color:#b3b7d2;">6/10</span>
            </label>
            <label>
              Baseline sensitivity
              <input type="range" id="anxSens" min="0" max="10" value="5" oninput="updateAnxLabel('sens')">
              <span id="anxSensVal" style="font-size:10px;color:#b3b7d2;">5/10</span>
            </label>
            <label class="full-span">
              Foods and notes
              <textarea id="anxFoods" placeholder="Small bowl of cereal, 2 cookies, soda before bed, etc..."></textarea>
            </label>
          </div>
          <p class="mini-label">
            In the full version, this foods box will feed the AI so it can estimate how heavy the sugar / carb load was and fold it into the spike and crash timing.
          </p>
        </div>
      </div>
    </div>
  </div>
    <script>
  const HISTORY_KEY = 'brcHistory_v1';
  let currentMode = 'ibs';

  // Simple food recognition table - can expand later
  const FOOD_KEYWORDS = [
    { label: 'Sugary cereal', keywords: ['cereal', 'cinnamon toast crunch', 'frosted flakes', 'lucky charms', 'cap n crunch'], sugar: 9, carbs: 8 },
    { label: 'Pancakes or waffles with syrup', keywords: ['pancakes', 'waffles', 'syrup'], sugar: 9, carbs: 8 },
    { label: 'White bread / toast', keywords: ['white bread', 'toast', 'bagel', 'english muffin'], sugar: 4, carbs: 7 },
    { label: 'Pizza', keywords: ['pizza'], sugar: 4, carbs: 8 },
    { label: 'Pasta', keywords: ['pasta', 'spaghetti', 'mac and cheese', 'macaroni'], sugar: 3, carbs: 8 },
    { label: 'White rice', keywords: ['white rice', 'fried rice', 'rice bowl'], sugar: 3, carbs: 7 },
    { label: 'Chips / crisps', keywords: ['chips', 'doritos', 'tortilla chips', 'kettle chips', 'fries'], sugar: 3, carbs: 7 },
    { label: 'Candy', keywords: ['candy', 'skittles', 'gummy', 'gummies', 'starburst', 'jelly bean'], sugar: 10, carbs: 6 },
    { label: 'Cookies', keywords: ['cookie', 'cookies', 'oreos'], sugar: 9, carbs: 6 },
    { label: 'Cake / cupcakes', keywords: ['cake', 'cupcake', 'cupcakes', 'brownie', 'brownies'], sugar: 9, carbs: 6 },
    { label: 'Ice cream', keywords: ['ice cream', 'gelato', 'frozen yogurt', 'froyo'], sugar: 9, carbs: 5 },
    { label: 'Sugary drinks', keywords: ['soda', 'coke', 'cola', 'pepsi', 'sprite', 'mountain dew', 'dr pepper', 'energy drink', 'red bull', 'monster'], sugar: 10, carbs: 6 },
    { label: 'Juice', keywords: ['juice', 'orange juice', 'apple juice', 'grape juice'], sugar: 8, carbs: 5 },
    { label: 'Chocolate', keywords: ['chocolate', 'm&m', 'm & m'], sugar: 8, carbs: 5 },
    { label: 'Sweetened coffee drink', keywords: ['frappuccino', 'latte', 'mocha', 'iced coffee', 'coffee drink'], sugar: 7, carbs: 4 },
    { label: 'Oatmeal', keywords: ['oatmeal', 'oats', 'porridge'], sugar: 3, carbs: 6 },
    { label: 'Fruit (moderate)', keywords: ['banana', 'apple', 'grapes', 'mango', 'pineapple'], sugar: 5, carbs: 4 },
    { label: 'Low sugar meal', keywords: ['eggs', 'omelette', 'chicken', 'salad', 'broccoli', 'steamed veggies', 'fish', 'steak'], sugar: 1, carbs: 2 },
    { label: 'Nuts', keywords: ['nuts', 'almonds', 'cashews', 'peanuts'], sugar: 1, carbs: 2 },
    { label: 'Yogurt', keywords: ['yogurt', 'yoghurt'], sugar: 5, carbs: 4 }
  ];

  function estimateFoodLoad(text) {
    if (!text) {
      return { sugar: 0, carbs: 0, matches: [] };
    }
    const lower = text.toLowerCase();
    let maxSugar = 0;
    let maxCarbs = 0;
    const matches = [];

    for (const item of FOOD_KEYWORDS) {
      const hit = item.keywords.some(k => lower.includes(k));
      if (hit) {
        matches.push(item.label);
        if (item.sugar > maxSugar) maxSugar = item.sugar;
        if (item.carbs > maxCarbs) maxCarbs = item.carbs;
      }
    }

    return { sugar: maxSugar, carbs: maxCarbs, matches };
  }

  function setMode(mode) {
    currentMode = mode;
    const ibsPanel = document.getElementById('ibsPanel');
    const anxPanel = document.getElementById('anxPanel');
    const modeIbs = document.getElementById('modeIbs');
    const modeAnx = document.getElementById('modeAnx');

    if (mode === 'ibs') {
      ibsPanel.style.display = '';
      anxPanel.style.display = 'none';
      modeIbs.classList.add('active');
      modeAnx.classList.remove('active');
    } else {
      ibsPanel.style.display = 'none';
      anxPanel.style.display = '';
      modeAnx.classList.add('active');
      modeIbs.classList.remove('active');
    }
  }

  function addMessage(sender, text) {
    const box = document.getElementById('chatMessages');
    const div = document.createElement('div');
    div.className = 'chat-msg';
    div.innerHTML = `<strong>${sender}:</strong> ${text}`;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
  }

  // Chat uses local "brain" based on current state
  function sendChat() {
    const input = document.getElementById('chatInput');
    const text = input.value.trim();
    if (!text) return;

    addMessage('You', text);
    input.value = '';

    const snapshot = getStateSnapshot();
    const reply = generateLocalAIReply(text, snapshot);
    addMessage('App', reply);
  }

  function updateLabel(which) {
    if (which === 'stress') {
      const v = document.getElementById('stress').value;
      document.getElementById('stressVal').textContent = `${v}/10`;
    }
    if (which === 'shoulder') {
      const v = document.getElementById('shoulder').value;
      document.getElementById('shoulderVal').textContent = `${v}/10`;
    }
    if (which === 'gut') {
      const v = document.getElementById('gut').value;
      document.getElementById('gutVal').textContent = `${v}/10`;
    }
    if (which === 'anx') {
      const v = document.getElementById('anx').value;
      document.getElementById('anxVal').textContent = `${v}/10`;
    }
    if (which === 'pain') {
      const v = document.getElementById('bmPain').value;
      document.getElementById('bmPainVal').textContent = `${v}/10`;
    }
  }

  function updateAnxLabel(which) {
    if (which === 'sugar') {
      const v = document.getElementById('anxSugar').value;
      document.getElementById('anxSugarVal').textContent = `${v}/10`;
    }
    if (which === 'caf') {
      const v = document.getElementById('anxCaf').value;
      document.getElementById('anxCafVal').textContent = `${v}/10`;
    }
    if (which === 'sleep') {
      const v = document.getElementById('anxSleep').value;
      document.getElementById('anxSleepVal').textContent = `${v}/10`;
    }
    if (which === 'sens') {
      const v = document.getElementById('anxSens').value;
      document.getElementById('anxSensVal').textContent = `${v}/10`;
    }
  }

  function timeToMinutes(id) {
    const t = document.getElementById(id).value;
    if (!t) return null;
    const [h, m] = t.split(':').map(Number);
    return h * 60 + m;
  }

  function parseTimeStringToMinutes(t) {
    if (!t) return null;
    const parts = t.split(':');
    if (parts.length < 2) return null;
    const h = Number(parts[0]);
    const m = Number(parts[1]);
    if (Number.isNaN(h) || Number.isNaN(m)) return null;
    return h * 60 + m;
  }

  function minutesToClockString(mins) {
    if (mins == null) return '';
    let m = mins % (24 * 60);
    if (m < 0) m += 24 * 60;
    const hour = Math.floor(m / 60);
    const minute = m % 60;
    const ampm = hour >= 12 ? 'pm' : 'am';
    const hour12 = ((hour + 11) % 12) + 1;
    const minuteStr = minute.toString().padStart(2, '0');
    return `${hour12}:${minuteStr} ${ampm}`;
  }

  function loadHistory() {
    try {
      const raw = localStorage.getItem(HISTORY_KEY);
      if (!raw) return [];
      const data = JSON.parse(raw);
      return Array.isArray(data) ? data : [];
    } catch {
      return [];
    }
  }

  function saveHistory(list) {
    localStorage.setItem(HISTORY_KEY, JSON.stringify(list));
  }

  function renderHistory() {
    const list = loadHistory();
    const ul = document.getElementById('historyList');
    ul.innerHTML = '';
    if (!list.length) {
      const li = document.createElement('li');
      li.textContent = 'No days logged yet.';
      ul.appendChild(li);
      return;
    }
    list.slice(-7).reverse().forEach(entry => {
      const li = document.createElement('li');
      li.innerHTML = `<span class="history-label">${entry.dayLabel}</span> · ${entry.label} · driver: ${entry.driver}`;
      ul.appendChild(li);
    });
  }

  function classifyDay(info) {
    const { drinkGap, stress, anx, shoulder, gut, bmForm, bmPain } = info;

    let label = 'Recovery / mixed';

    if (
      drinkGap != null && drinkGap >= 90 &&
      stress <= 4 && anx <= 4 &&
      shoulder <= 5 &&
      gut >= 6 &&
      bmPain <= 2 &&
      bmForm >= 3 && bmForm <= 5
    ) {
      label = 'Stable';
    } else if (
      bmForm >= 6 ||
      bmPain >= 5 ||
      (drinkGap != null && drinkGap < 60) ||
      stress >= 7 ||
      anx >= 7
    ) {
      label = 'Sensitive';
    }

    const drivers = [];
    if (drinkGap != null && drinkGap < 75) drivers.push('late/tight last drink to magnesium glycinate gap');
    if (stress >= 6) drivers.push('high stress');
    if (anx >= 6) drivers.push('high anxiety');
    if (shoulder >= 6) drivers.push('shoulder/neck tension');
    if (bmForm >= 6) drivers.push('soft/watery form');
    if (bmPain >= 5) drivers.push('higher pain');

    const driver = drivers[0] || 'no single dominant factor';

    return { label, driver };
  }

  // Snapshot of all sliders / timing / foods
  function getStateSnapshot() {
    const stress = +document.getElementById('stress').value;
    const shoulder = +document.getElementById('shoulder').value;
    const gut = +document.getElementById('gut').value;
    const anx = +document.getElementById('anx').value;

    const dinTime = document.getElementById('dinTime').value;
    const foodTime = document.getElementById('foodTime').value;
    const drinkTime = document.getElementById('drinkTime').value;
    const magTime = document.getElementById('magTime').value;
    const sleepTime = document.getElementById('sleepTime').value;
    const wakeTime = document.getElementById('wakeTime').value;

    const bmTime = document.getElementById('bmTime').value;
    const bmPain = +document.getElementById('bmPain').value;
    const bmForm = +document.getElementById('bmForm').value;
    const ibsMeal = document.getElementById('ibsMeal').value.trim();

    const anxHitTime = document.getElementById('anxHitTime').value;
    const anxSugar = +document.getElementById('anxSugar').value;
    const anxCaf = +document.getElementById('anxCaf').value;
    const anxSleep = +document.getElementById('anxSleep').value;
    const anxSens = +document.getElementById('anxSens').value;
    const anxFoods = document.getElementById('anxFoods').value.trim();

    return {
      mode: currentMode,
      ibs: {
        stress,
        shoulder,
        gutComfort: gut,
        anxiety: anx,
        dinnerTime: dinTime,
        lastFoodTime: foodTime,
        lastDrinkTime: drinkTime,
        magnesiumGlycinateTime: magTime,
        sleepTime,
        wakeTime,
        bmTime,
        bmPain,
        bmForm,
        lastMealDescription: ibsMeal
      },
      anxietySide: {
        mainHitTime: anxHitTime,
        sugarLoad: anxSugar,
        caffeineLoad: anxCaf,
        sleepQuality: anxSleep,
        baselineSensitivity: anxSens,
        foodsNotes: anxFoods
      }
    };
  }

  // Local AI-style reply from snapshot
  function generateLocalAIReply(userText, snapshot) {
    if (snapshot.mode === 'ibs') {
      const s = snapshot.ibs;

      const drinkM = parseTimeStringToMinutes(s.lastDrinkTime);
      const magM = parseTimeStringToMinutes(s.magnesiumGlycinateTime);
      const drinkGap = (drinkM != null && magM != null) ? (magM - drinkM) : null;
      const bmM = parseTimeStringToMinutes(s.bmTime);

      const classification = classifyDay({
        drinkGap,
        stress: s.stress,
        anx: s.anxiety,
        shoulder: s.shoulder,
        gut: s.gutComfort,
        bmForm: s.bmForm,
        bmPain: s.bmPain
      });

      let msg = `Today at a glance: ${classification.label} day, main driver: ${classification.driver}. `;

      if (drinkGap != null) {
        if (drinkGap < 60) {
          msg += 'The last drink to magnesium glycinate gap is short; your system often reads that as softer or more unpredictable mornings. ';
        } else if (drinkGap >= 90) {
          msg += 'Your last drink to magnesium glycinate gap is wide enough to usually support a more stable morning. ';
        }
      }

      if (s.shoulder >= 7) {
        msg += 'Shoulder and neck tension are high, so left side awareness and descending shoulder to gut sensations may feel louder even if the gut itself is behaving. ';
      }

      if (s.anxiety >= 6 && s.stress >= 6) {
        msg += 'Both stress and anxiety are elevated; that turns up the volume knob on normal gut sensations and makes them feel more like a threat. ';
      }

      if (s.gutComfort >= 7 && s.stress <= 3 && (drinkGap == null || drinkGap >= 90)) {
        msg += 'Overall this looks close to your good pattern setup: calmer nervous system and decent timing. ';
      }

      if (s.bmForm >= 6) {
        msg += 'This morning’s form is on the softer side, which usually tracks with either tight liquid timing or a recent stretch of higher nervous system load. ';
      } else if (s.bmForm === 4 && s.bmPain <= 2) {
        msg += 'Smooth form and low pain line up with your more stable pattern days. ';
      }

      if (s.lastMealDescription) {
        msg += `Last meal logged as: ${s.lastMealDescription}. In a fuller build, the app would use that mostly for context while timing and nervous system state do most of the heavy lifting. `;
      }

      if (userText.toLowerCase().includes('tomorrow')) {
        msg += 'Given this setup, tomorrow is more likely to be sensitive but manageable rather than a true flare, unless timing gets much tighter or stress spikes. ';
      }

      return msg.trim();
    } else {
      const a = snapshot.anxietySide;

      const hitM = parseTimeStringToMinutes(a.mainHitTime);
      const foodEstimate = estimateFoodLoad(a.foodsNotes);
      const effectiveSugar = Math.max(a.sugarLoad, foodEstimate.sugar);

      let score = 0;
      if (effectiveSugar >= 6) score++;
      if (a.caffeineLoad >= 5) score++;
      if (a.sleepQuality <= 4) score++;
      if (a.baselineSensitivity >= 7) score++;

      let risk = 'Low';
      if (score === 2) risk = 'Moderate';
      if (score >= 3) risk = 'High';

      let driver = 'mixed factors';
      if (effectiveSugar >= 7 && a.caffeineLoad >= 5) {
        driver = 'big sugar plus caffeine load';
      } else if (effectiveSugar >= 6 && a.caffeineLoad <= 3) {
        driver = 'heavier carbs with low caffeine';
      } else if (effectiveSugar <= 3 && a.caffeineLoad >= 7) {
        driver = 'caffeine more than sugar';
      } else if (a.sleepQuality <= 4 && a.baselineSensitivity >= 7) {
        driver = 'thin sleep and high sensitivity';
      }

      let spikeStart = null;
      let spikeEnd = null;
      let crashStart = null;
      let crashEnd = null;

      if (hitM != null) {
        if (effectiveSugar >= 7 && a.caffeineLoad >= 5) {
          spikeStart = hitM + 30;
          spikeEnd = hitM + 90;
          crashStart = hitM + 120;
          crashEnd = hitM + 240;
        } else if (effectiveSugar >= 6 && a.caffeineLoad <= 3) {
          spikeStart = hitM + 60;
          spikeEnd = hitM + 120;
          crashStart = hitM + 180;
          crashEnd = hitM + 300;
        } else if (effectiveSugar <= 3 && a.caffeineLoad >= 7) {
          spikeStart = hitM + 30;
          spikeEnd = hitM + 90;
          crashStart = hitM + 180;
          crashEnd = hitM + 300;
        } else {
          spikeStart = hitM + 60;
          spikeEnd = hitM + 150;
          crashStart = hitM + 180;
          crashEnd = hitM + 300;
        }
      }

      let msg = `Crash risk: ${risk}. Main driver: ${driver}. `;

      if (hitM != null && spikeStart != null && crashStart != null) {
        const spikeWindow = `${minutesToClockString(spikeStart)} to ${minutesToClockString(spikeEnd)}`;
        const crashWindow = `${minutesToClockString(crashStart)} to ${minutesToClockString(crashEnd)}`;
        msg += `Spike window: ${spikeWindow}. Crash window: ${crashWindow}. `;
      } else {
        msg += 'Set a main carb or sugar time to get a more precise spike and crash window. ';
      }

      if (a.foodsNotes) {
        if (foodEstimate.matches.length) {
          msg += `From your foods, this looks like roughly a ${effectiveSugar}/10 sugar day (matches: ${foodEstimate.matches.join(', ')}). `;
        } else {
          msg += 'Foods are logged but did not match the common list yet; in a fuller build the app would learn more items over time. ';
        }
      }

      if (a.sleepQuality <= 4 || a.baselineSensitivity >= 7) {
        msg += 'Because sleep is thin or sensitivity is high, whatever lands inside that crash window is likely to feel louder than it really is. ';
      }

      let meaning;
      if (risk === 'High') {
        meaning = 'wired then flat kind of day, with more body noise than usual in the crash window.';
      } else if (risk === 'Moderate') {
        meaning = 'mild spike then drift-down day; you may feel off in the crash window but not wrecked.';
      } else {
        meaning = 'low crash risk day; small waves more than a true crash.';
      }

      msg += `What this means: ${meaning}`;

      return msg.trim();
    }
  }

  /* IBS quick actions */
  function preset(type) {
    const stress = +document.getElementById('stress').value;
    const shoulder = +document.getElementById('shoulder').value;
    const gut = +document.getElementById('gut').value;
    const anx = +document.getElementById('anx').value;

    const tDinner = timeToMinutes('dinTime');
    const tFood = timeToMinutes('foodTime');
    const tDrink = timeToMinutes('drinkTime');
    const tMag = timeToMinutes('magTime');
    const tSleep = timeToMinutes('sleepTime');
    const tWake = timeToMinutes('wakeTime');

    const tBm = timeToMinutes('bmTime');
    const bmForm = +document.getElementById('bmForm').value;
    const bmPain = +document.getElementById('bmPain').value;

    const ibsMeal = document.getElementById('ibsMeal').value.trim();

    const drinkGap = tMag != null && tDrink != null ? tMag - tDrink : null;
    const foodGap = tSleep != null && tFood != null ? tSleep - tFood : null;

    if (type === 'log_today') {
      let summary = `Save today: stress=${stress}, shoulder=${shoulder}, gut=${gut}, anxiety=${anx}, BM form=${bmForm}, BM pain=${bmPain}.`;
      addMessage('You', summary);
      if (ibsMeal) {
        addMessage('You', `Last meal: ${ibsMeal}`);
      }

      const classification = classifyDay({
        drinkGap,
        stress,
        anx,
        shoulder,
        gut,
        bmForm,
        bmPain
      });

      const today = new Date();
      const dayLabel = today.toLocaleDateString(undefined, {
        weekday: 'short',
        month: 'numeric',
        day: 'numeric'
      });

      const history = loadHistory();
      history.push({
        dayLabel,
        label: classification.label,
        driver: classification.driver
      });
      const trimmed = history.slice(-30);
      saveHistory(trimmed);
      renderHistory();

      addMessage(
        'App',
        `Today at a glance: ${classification.label} day, main driver: ${classification.driver}.`
      );

      addMessage(
        'App',
        `Logged as a "${classification.label}" day with main driver: ${classification.driver}. In a full build this history would be used to refine your personal rhythm model over time.`
      );
    }

    if (type === 'insight') {
      addMessage('You', 'Show me today’s pattern.');
      let msg;

      if (drinkGap !== null && drinkGap < 75) {
        msg = 'Your last drink is fairly close to magnesium glycinate. On systems like yours, mornings tend to be softer or more unpredictable when the gap is under about 75 to 90 minutes.';
      } else if (shoulder >= 7) {
        msg = 'Shoulder tension is high. On days like this, splenic flexure and left side sensitivity often show up even if digestion itself is fine. This is more nervous system than gut tissue.';
      } else if (anx >= 6 && stress >= 6) {
        msg = 'Both stress and anxiety are elevated. That usually raises your internal volume knob and makes normal sensations feel louder, even when timing is decent.';
      } else if (gut >= 7 && stress <= 3 && (drinkGap === null || drinkGap >= 90)) {
        msg = 'This looks close to your stable rhythm: decent gut comfort, low stress, and a solid gap between last drink and magnesium glycinate. That is usually a strong setup for a predictable morning.';
      } else {
        msg = 'Today looks mixed. Nothing screams disaster, but sensitivity is a bit elevated. Small improvements in cutoff or evening calm will likely pay off tomorrow.';
      }

      if (tBm != null) {
        if (bmForm >= 6) {
          msg += ' This morning’s form suggests your system is still on the softer side. Often that tracks back to either a tight last drink to magnesium glycinate gap or more nervous system load than ideal.';
        } else if (bmForm === 4 && bmPain <= 2) {
          msg += ' The morning outcome you logged (smooth form and low pain) fits your more stable pattern, which is a good sign that your timing is on the right track.';
        }
      }

      addMessage('App', msg);
    }

    if (type === 'forecast') {
      addMessage('You', 'Predict tomorrow morning.');

      let msg = 'Given this setup, tomorrow looks like a sensitive but workable morning. Not perfect, not terrible. Expect more awareness than true pain.';

      if (drinkGap !== null && drinkGap >= 90 && stress <= 3 && anx <= 3 && shoulder <= 4 && gut >= 6) {
        msg = 'This is one of your stronger setups. I would expect a single mostly solid morning BM, low pain, and a quieter nervous system overall.';
      } else if (drinkGap !== null && drinkGap < 60) {
        msg = 'Tomorrow has a higher chance of a soft or partly watery morning, mostly due to the tight last drink to magnesium glycinate gap. Not dangerous, just less stable.';
      } else if (anx >= 7 || stress >= 7) {
        msg = 'Tomorrow may feel louder in your body even if the gut behaves. Expect more internal noise, mostly driven by nervous system state rather than true gut trouble.';
      }

      addMessage('App', msg);
    }

    if (type === 'explain') {
      addMessage('You', 'Explain my system.');
      const msg =
        'You have a timing sensitive, nervous system heavy pattern. Evenings with calmer stress, lower shoulder tension, and a clear cutoff between last drink and magnesium glycinate usually give you stable mornings. When stress, anxiety, or shoulder tension run high, your sensitivity goes up even if nothing is wrong in the gut itself.';
      addMessage('App', msg);
    }

    if (type === 'driving') {
      addMessage('You', 'What is driving today?');
      let drivers = [];

      if (drinkGap !== null && drinkGap < 75) drivers.push('tight last drink to magnesium glycinate gap');
      if (shoulder >= 6) drivers.push('shoulder and neck tension');
      if (anx >= 6) drivers.push('anxiety level');
      if (stress >= 6) drivers.push('overall stress load');

      if (drivers.length === 0) {
        addMessage(
          'App',
          'Nothing is screaming as a strong driver today from the sliders alone. This looks more like a fine tune and watch what happens kind of day rather than a clear trigger day.'
        );
      } else {
        addMessage(
          'App',
          `The main drivers tonight look like: ${drivers.join(', ')}. Those are the knobs that usually change your sensitivity the most.`
        );
      }
    }

    if (type === 'questions') {
      addMessage('You', 'Ask me some narrowing questions.');

      const qs = [];

      if (drinkGap !== null && drinkGap < 75) {
        qs.push('Your last drink is fairly close to magnesium glycinate. On nights like this, have your worst or softest mornings usually happened, or does it still feel random to you?');
      }
      if (shoulder >= 7) {
        qs.push('With shoulder tension this high, do you usually notice more left side gut awareness or splenic flexure style pressure either that night or the next morning?');
      }
      if (anx >= 6) {
        qs.push('When anxiety is this elevated, do you tend to feel the anxiety first and then the gut reacts, or does the gut flare first and your mind responds after?');
      }
      if (stress >= 6 && anx < 6) {
        qs.push('Stress is high but anxiety is a bit lower. Does your body hold this mostly in muscle tension (shoulders, neck, jaw), or does your gut often join in too on days like this?');
      }
      if (gut <= 4) {
        qs.push('Gut comfort is low. Would you describe it more as sharp pain, pressure, bloating, or just hypersensitive awareness where everything inside feels too loud?');
      }

      if (!qs.length) {
        qs.push('Nothing jumps out as a clear driver from the sliders alone. If you had to guess, what part of today feels most off: timing, stress, sleep, or body tension?');
      }

      qs.forEach(q => addMessage('App', q));
    }
  }

  /* Anxiety actions */
  function anxAction(type) {
    const sugar = +document.getElementById('anxSugar').value;
    const caf = +document.getElementById('anxCaf').value;
    const sleep = +document.getElementById('anxSleep').value;
    const sens = +document.getElementById('anxSens').value;
    const foods = document.getElementById('anxFoods').value.trim();
    const hitTime = timeToMinutes('anxHitTime');

    const foodEstimate = estimateFoodLoad(foods);
    const effectiveSugar = Math.max(sugar, foodEstimate.sugar);

    if (type === 'log') {
      addMessage('You', `Log anxiety day: sugar slider=${sugar}/10, caffeine=${caf}/10, sleep=${sleep}/10, baseline sensitivity=${sens}/10.`);
      if (foods) {
        addMessage('You', `Foods / notes: ${foods}`);
      }
      if (foodEstimate.matches.length) {
        addMessage('App', `From foods this looks like about a ${effectiveSugar}/10 sugar load (matches: ${foodEstimate.matches.join(', ')}).`);
      } else if (foods) {
        addMessage('App', 'Foods are logged but did not match the current list yet. Slider value is used as the main sugar estimate.');
      }
      addMessage('App', 'Logged this anxiety day. In a full build this would be stored along with your IBS timing so both rhythms can be compared side by side.');
    }

    if (type === 'forecast') {
      addMessage('You', 'Show spike / crash time.');

      let score = 0;
      if (effectiveSugar >= 6) score++;
      if (caf >= 5) score++;
      if (sleep <= 4) score++;
      if (sens >= 7) score++;

      let risk = 'Low';
      if (score === 2) risk = 'Moderate';
      if (score >= 3) risk = 'High';

      let driver = 'mixed factors';
      if (effectiveSugar >= 7 && caf >= 5) {
        driver = 'big sugar plus caffeine load';
      } else if (effectiveSugar >= 6 && caf <= 3) {
        driver = 'heavier carbs with low caffeine';
      } else if (effectiveSugar <= 3 && caf >= 7) {
        driver = 'caffeine more than sugar';
      } else if (sleep <= 4 && sens >= 7) {
        driver = 'thin sleep and high sensitivity';
      }

      let spikeStart = null;
      let spikeEnd = null;
      let crashStart = null;
      let crashEnd = null;

      if (hitTime != null) {
        if (effectiveSugar >= 7 && caf >= 5) {
          spikeStart = hitTime + 30;
          spikeEnd = hitTime + 90;
          crashStart = hitTime + 120;
          crashEnd = hitTime + 240;
        } else if (effectiveSugar >= 6 && caf <= 3) {
          spikeStart = hitTime + 60;
          spikeEnd = hitTime + 120;
          crashStart = hitTime + 180;
          crashEnd = hitTime + 300;
        } else if (effectiveSugar <= 3 && caf >= 7) {
          spikeStart = hitTime + 30;
          spikeEnd = hitTime + 90;
          crashStart = hitTime + 180;
          crashEnd = hitTime + 300;
        } else {
          spikeStart = hitTime + 60;
          spikeEnd = hitTime + 150;
          crashStart = hitTime + 180;
          crashEnd = hitTime + 300;
        }
      }

      let msg = `Crash risk: ${risk}. Main driver: ${driver}. `;

      if (hitTime != null && spikeStart != null && crashStart != null) {
        const spikeWindow = `${minutesToClockString(spikeStart)} to ${minutesToClockString(spikeEnd)}`;
        const crashWindow = `${minutesToClockString(crashStart)} to `${minutesToClockString(crashEnd)}`;
      }</script>
</body>
</html>
