<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Carb / Sugar Anxiety Timing Explorer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta
    name="description"
    content="Free, biology-informed carb / sugar / caffeine timing explorer for people who notice waves of anxiety 1‚Äì4 hours after meals."
  />
  <style>
    :root {
      --bg-main: #050814;
      --bg-card: #0b0f26;
      --bg-card-alt: #0e122b;
      --border-subtle: rgba(255, 255, 255, 0.06);
      --accent: #4da8ff;
      --accent-soft: rgba(77, 168, 255, 0.18);
      --accent-strong: #00d17a;
      --accent-strong-soft: rgba(0, 209, 122, 0.18);
      --text-main: #f5f7ff;
      --text-soft: #b1b6ca;
      --text-softer: #7c8092;
      --danger: #ff5c5c;
      --danger-soft: rgba(255, 92, 92, 0.18);
      --warning: #ffc857;
      --warning-soft: rgba(255, 200, 87, 0.25);
      --timeline-spike: #ffd447;
      --timeline-crash: #ff6b6b;
      --timeline-recovery: #4dabff;
      --pill-bg: rgba(255, 255, 255, 0.05);
      --pill-border: rgba(255, 255, 255, 0.12);
      --pill-bg-active: rgba(0, 209, 122, 0.16);
      --pill-border-active: #00d17a;
      --shadow-soft: 0 24px 70px rgba(0, 0, 0, 0.65);
      --radius-card: 18px;
      --radius-pill: 999px;
      --font-size-base: 16px;
      --font-size-small: 13px;
      --font-size-label: 14px;
      --font-size-heading: 22px;
      --font-size-h1: 24px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui,
        -system-ui, sans-serif;
      background: radial-gradient(circle at top, #11172e 0, #050814 42%, #01020a 100%);
      color: var(--text-main);
    }

    .app-shell {
      max-width: 1120px;
      margin: 0 auto;
      padding: 20px 14px 40px;
    }

    h1 {
      font-size: var(--font-size-h1);
      letter-spacing: 0.12em;
      text-transform: uppercase;
      margin: 0 0 6px;
    }

    .app-subtitle {
      margin: 0 0 16px;
      color: var(--text-soft);
      font-size: var(--font-size-small);
      max-width: 640px;
    }

    .app-grid {
      margin-top: 10px;
      display: grid;
      grid-template-columns: minmax(0, 1.15fr) minmax(0, 1fr);
      gap: 10px;
    }

    @media (max-width: 950px) {
      .app-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    #right-column {
      position: sticky;
      top: 10px;
      align-self: flex-start;
      height: fit-content;
    }

    @media (max-width: 950px) {
      #right-column {
        position: static;
      }
    }

    .card {
      background: radial-gradient(circle at top left, #111827, #020515 60%);
      border-radius: var(--radius-card);
      padding: 14px 16px 16px;
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
    }

    .card-tight {
      padding-top: 9px;
      padding-bottom: 10px;
    }

    .card-title {
      font-size: var(--font-size-label);
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--text-soft);
      margin-bottom: 4px;
    }

    .card-subtitle {
      font-size: var(--font-size-small);
      color: var(--text-softer);
      margin-bottom: 10px;
      line-height: 1.5;
    }

    .input-label {
      display: block;
      font-size: var(--font-size-label);
      color: var(--text-soft);
      margin-bottom: 4px;
    }

    input[type="time"],
    input[type="number"],
    input[type="text"] {
      width: 100%;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.14);
      background: rgba(0, 0, 0, 0.35);
      color: var(--text-main);
      font-size: var(--font-size-label);
      outline: none;
    }

    input[type="time"]:focus,
    input[type="number"]:focus,
    input[type="text"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(77, 168, 255, 0.4);
    }

    /* Range slider */
    input[type="range"] {
      width: 100%;
      appearance: none;
      height: 8px;
      border-radius: 999px;
      background: linear-gradient(
        90deg,
        rgba(77, 168, 255, 0.18),
        rgba(0, 209, 122, 0.2)
      );
      outline: none;
      margin-top: 5px;
    }

    input[type="range"]::-webkit-slider-thumb {
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #ffffff;
      border: 2px solid var(--accent);
      box-shadow: 0 0 0 3px rgba(77, 168, 255, 0.4);
      cursor: pointer;
      margin-top: -5px;
    }

    input[type="range"]::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #ffffff;
      border: 2px solid var(--accent);
      box-shadow: 0 0 0 3px rgba(77, 168, 255, 0.4);
      cursor: pointer;
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .pill {
      border-radius: var(--radius-pill);
      padding: 5px 11px;
      font-size: var(--font-size-small);
      border: 1px solid var(--pill-border);
      background: var(--pill-bg);
      color: var(--text-soft);
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
      transition: background 0.15s ease, border-color 0.15s ease,
        color 0.15s ease, transform 0.08s ease;
    }

    .pill:hover {
      transform: translateY(-0.5px);
      border-color: rgba(255, 255, 255, 0.35);
    }

    .pill.active {
      background: var(--pill-bg-active);
      border-color: var(--pill-border-active);
      color: #ccffe9;
    }

    .pill.danger {
      background: var(--danger-soft);
      border-color: var(--danger);
      color: #ffecec;
    }

    .pill-tag {
      font-size: 11px;
      color: var(--text-softer);
      margin-top: 2px;
    }

    .meal-search-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 6px;
    }

    .meal-search-input {
      flex: 1;
    }

    .small-btn {
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      background: rgba(0, 0, 0, 0.38);
      color: var(--text-soft);
      padding: 5px 11px;
      font-size: var(--font-size-small);
      cursor: pointer;
    }

    .small-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .meal-grid {
      margin-top: 4px;
      max-height: 260px;
      overflow-y: auto;
    }

    .meal-category-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--text-softer);
      margin: 6px 0 2px;
    }

    .meal-badges-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: 6px;
    }

    .meal-pill {
      border-radius: 14px;
      padding: 7px 10px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      cursor: pointer;
      font-size: var(--font-size-small);
    }

    .meal-pill.active {
      border-color: var(--accent-strong);
      background: var(--accent-soft);
    }

    .meal-pill-title {
      font-weight: 500;
      margin-bottom: 1px;
    }

    .meal-pill-sub {
      font-size: 11px;
      color: var(--text-softer);
    }

    .meal-pill-tag {
      font-size: 11px;
      margin-top: 2px;
      color: var(--text-soft);
    }

    .risk-score-big {
      font-size: 34px;
      font-weight: 600;
      text-align: center;
      margin: 4px 0 2px;
    }

    .risk-score-label-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
      font-size: var(--font-size-small);
    }

    .risk-pill {
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      border: 1px solid rgba(0, 0, 0, 0);
      background: var(--accent-strong-soft);
      color: #c9ffe7;
    }

    .risk-pill.low {
      background: var(--accent-strong-soft);
      border-color: var(--accent-strong);
    }

    .risk-pill.moderate {
      background: var(--warning-soft);
      border-color: var(--warning);
      color: #fff5d5;
    }

    .risk-pill.high {
      background: var(--danger-soft);
      border-color: var(--danger);
      color: #ffe5e5;
    }

    .risk-gauge-bar {
      position: relative;
      width: 100%;
      height: 16px;
      border-radius: 999px;
      background: linear-gradient(
        90deg,
        #00d17a,
        #e7d85b,
        #f29c3b,
        #ff5c5c
      );
      margin-top: 6px;
      margin-bottom: 2px;
    }

    .risk-gauge-indicator {
      position: absolute;
      top: -3px;
      width: 2px;
      height: 22px;
      background: #ffffff;
      border-radius: 999px;
    }

    .risk-gauge-scale {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--text-softer);
      margin-top: 2px;
    }

    .risk-gauge-caption {
      font-size: 11px;
      color: var(--text-softer);
      margin-top: 2px;
    }

    /* Timeline */

    .timeline-bar-wrapper {
      position: relative;
      width: 100%;
      height: 18px;
      border-radius: 999px;
      background: #15182a;
      overflow: hidden;
      margin-top: 8px;
      margin-bottom: 6px;
    }

    .timeline-segment {
      position: absolute;
      top: 0;
      bottom: 0;
    }

    .timeline-spike {
      left: 0;
      width: 25%;
      background: var(--timeline-spike);
    }

    .timeline-crash {
      left: 25%;
      width: 35%;
      background: var(--timeline-crash);
    }

    .timeline-recovery {
      left: 60%;
      width: 40%;
      background: var(--timeline-recovery);
    }

    .timeline-you-line {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 2px;
      background: #ffffff;
    }

    .timeline-legend-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 4px;
      font-size: 11px;
      color: var(--text-softer);
    }

    .legend-left {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .legend-dot {
      display: inline-block;
      width: 9px;
      height: 9px;
      border-radius: 50%;
      margin-right: 4px;
    }

    .legend-label {
      display: inline-flex;
      align-items: center;
    }

    .legend-right {
      font-size: 11px;
      color: var(--text-soft);
    }

    .section-heading-row {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      align-items: baseline;
      margin-bottom: 6px;
    }

    .microcopy {
      font-size: 11px;
      color: var(--text-softer);
      margin-top: 4px;
    }

    .crash-times-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 6px 24px;
      margin-top: 6px;
      font-size: var(--font-size-small);
    }

    .crash-times-grid b {
      display: block;
    }

    .summary-text {
      font-size: var(--font-size-small);
      color: var(--text-soft);
      line-height: 1.6;
    }

    .why-card-btn {
      width: 100%;
      border-radius: 999px;
      padding: 10px 12px;
      font-size: var(--font-size-label);
      border: 1px solid rgba(255, 255, 255, 0.16);
      background: radial-gradient(circle at top left, #1b2436, #050814 55%);
      color: var(--text-main);
      cursor: pointer;
    }

    .why-card-btn:hover {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(77, 168, 255, 0.4);
    }

    footer {
      margin-top: 16px;
      font-size: 11px;
      color: var(--text-softer);
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <h1>CARB / SUGAR ANXIETY TIMING EXPLORER</h1>
    <p class="app-subtitle">
      Rough, biology-informed pattern explorer for people who notice waves of anxiety
      1‚Äì4 hours after carbs, sugar and caffeine. Not medical advice.
    </p>

    <div class="app-grid">
      <!-- LEFT COLUMN -->
      <div id="left-column">
        <!-- TIMING -->
        <div class="card">
          <div class="card-title">Timing</div>
          <p class="card-subtitle">
            The model assumes a ~4 hour (240 min) wave: spike ‚Üí crash ‚Üí recovery.
          </p>

          <label class="input-label">What time did you finish this meal?</label>
          <input id="mealTimeInput" type="time" />

          <label class="input-label" style="margin-top: 12px;">
            Roughly how long has it been since you finished eating?
          </label>
          <input
            id="minutesSinceMealRange"
            type="range"
            min="0"
            max="240"
            value="0"
          />
          <div
            id="minutesSinceLabel"
            style="font-size: 12px; color: var(--text-soft); margin-top: 2px;"
          >
            0 minutes since meal.
          </div>
        </div>

        <!-- MEAL SELECTOR -->
        <div class="card">
          <div class="card-title">Simple: what did this meal look like?</div>
          <p class="card-subtitle">
            Start with a rough match. You can refine later with sugar and caffeine.
          </p>

          <div class="meal-search-row">
            <input
              id="mealSearchInput"
              class="meal-search-input"
              type="text"
              placeholder="Search: pasta, pizza, salad, rice bowl, burger..."
            />
            <button id="clearMealSearchBtn" class="small-btn">Clear</button>
          </div>

          <div
            id="selectedMealLabel"
            style="font-size: 12px; color: var(--text-soft); margin-bottom: 4px;"
          >
            No meal selected yet.
          </div>

          <div id="mealPresetsContainer" class="meal-grid"></div>
        </div>
                <!-- DESSERT AND DRINKS -->
        <div class="card">
          <div class="card-title">Dessert and drinks</div>

          <label class="input-label">Did you add dessert?</label>
          <div class="pill-row" id="dessertRow">
            <div class="pill" data-dessert="0">No dessert</div>
            <div class="pill" data-dessert="10">Small (~10 g sugar)</div>
            <div class="pill" data-dessert="20">Medium (~20 g)</div>
            <div class="pill" data-dessert="35">Big (~35 g)</div>
          </div>
          <div class="microcopy">
            Big dessert might be a bowl of ice cream, a big slice of cake, or 2‚Äì3 cookies.
          </div>

          <label class="input-label" style="margin-top: 10px;">
            Sugary drink with this meal?
          </label>
          <div class="pill-row" id="sugaryDrinkRow">
            <div class="pill" data-sugardrink="0">No sugary drink</div>
            <div class="pill" data-sugardrink="22">One soda or sweet drink</div>
            <div class="pill" data-sugardrink="35">Large soda</div>
            <div class="pill" data-sugardrink="55">Big or multiple sweet drinks</div>
          </div>
          <div class="microcopy">
            Think of drinks you had within a few hours of this plate.
          </div>

          <label class="input-label" style="margin-top: 10px;">
            Coffee or other caffeine?
          </label>
          <div class="pill-row" id="caffeineRow">
            <div class="pill" data-caffeine="0">No caffeine</div>
            <div class="pill" data-caffeine="80">Small coffee or tea</div>
            <div class="pill" data-caffeine="120">Regular coffee</div>
            <div class="pill" data-caffeine="180">Strong coffee / energy drink</div>
          </div>
          <div class="microcopy">
            This is only a rough guess of caffeine. Exact numbers are not required.
          </div>

          <label class="input-label" style="margin-top: 10px;">
            If your sugary drink was a soda, was it caffeinated?
          </label>
          <div class="pill-row" id="sodaCaffeineRow">
            <div class="pill" data-sodacaf="0">Not caffeinated / no soda</div>
            <div class="pill" data-sodacaf="40">Caffeinated soda (small / can)</div>
            <div class="pill" data-sodacaf="70">Large / multiple caffeinated sodas</div>
          </div>
          <div class="microcopy">
            This adds to the caffeine estimate above. If in doubt, leave at
            ‚ÄúNot caffeinated‚Äù.
          </div>
        </div>

        <!-- SENSITIVITY AND DAY PATTERN -->
        <div class="card">
          <div class="card-title">Sensitivity and day pattern</div>

          <label class="input-label">How carb-heavy has the rest of your day been?</label>
          <div class="pill-row" id="dayCarbRow">
            <div class="pill" data-daycarb="0">Low</div>
            <div class="pill" data-daycarb="1">Medium</div>
            <div class="pill" data-daycarb="2">High</div>
          </div>
          <div class="microcopy">
            0 = mostly light / low carb so far, 2 = lots of bread, pasta, sweets, snacks earlier.
          </div>

          <label class="input-label" style="margin-top: 10px;">
            Visceral gut sensitivity (volume knob)
          </label>
          <div class="pill-row" id="visceralRow">
            <div class="pill" data-visceral="0">Low</div>
            <div class="pill" data-visceral="1">Medium</div>
            <div class="pill" data-visceral="2">High</div>
          </div>
          <div class="microcopy">
            0 = gut rarely complains, 2 = gut feels every bubble and stretch.
          </div>

          <label class="input-label" style="margin-top: 10px;">
            Anxiety system sensitivity
          </label>
          <div class="pill-row" id="anxietyRow">
            <div class="pill" data-anxiety="0">Low</div>
            <div class="pill" data-anxiety="1">Medium</div>
            <div class="pill" data-anxiety="2">High</div>
          </div>
          <div class="microcopy">
            0 = rarely anxious, 2 = nervous system that notices every little crash.
          </div>
        </div>
      </div> <!-- /left-column -->
            <!-- RIGHT COLUMN -->
      <div id="right-column">
        <!-- SCORE CARD -->
        <div class="card">
          <div class="section-heading-row">
            <div class="card-title">Current projected score</div>
            <div style="font-size: 11px; color: var(--text-softer);">
              0‚Äì49 Low, 50‚Äì74 Moderate, 75+ High
            </div>
          </div>

          <div class="risk-score-big">
            <span id="scoreBig">0</span><span style="opacity: 0.75;"> / 100</span>
          </div>

          <div class="risk-score-label-row">
            <span id="scoreStatusText" style="color: var(--text-soft);">
              Very low wave activity right now.
            </span>
            <span id="scoreCategoryPill" class="risk-pill low">Low</span>
          </div>

          <div class="risk-gauge-bar">
            <div id="riskGaugeIndicator" class="risk-gauge-indicator"></div>
          </div>

          <div class="risk-gauge-scale">
            <span>Low</span>
            <span>25</span>
            <span>50</span>
            <span>75</span>
            <span>100</span>
          </div>
          <div class="risk-gauge-caption">
            Biology says this pattern should feel fairly steady for most people.
          </div>
        </div>

        <!-- TIMELINE CARD -->
        <div class="card">
          <div class="section-heading-row">
            <div class="card-title">Spike ‚Üí crash ‚Üí recovery timeline</div>
            <div style="font-size: 11px; color: var(--text-softer);">
              Shows where you are in the 0‚Äì240 minute wave.
            </div>
          </div>

          <p class="card-subtitle" style="margin-bottom: 6px;">
            Add a rough meal time to see your crash window in clock time.
          </p>

          <div class="timeline-bar-wrapper">
            <div class="timeline-segment timeline-spike"></div>
            <div class="timeline-segment timeline-crash"></div>
            <div class="timeline-segment timeline-recovery"></div>
            <div id="timelineYouLine" class="timeline-you-line"></div>
          </div>

          <div class="timeline-legend-row">
            <div class="legend-left">
              <span class="legend-label">
                <span
                  class="legend-dot"
                  style="background: var(--timeline-spike);"
                ></span>
                Spike window
              </span>
              <span class="legend-label">
                <span
                  class="legend-dot"
                  style="background: var(--timeline-crash);"
                ></span>
                Crash / anxiety window
              </span>
              <span class="legend-label">
                <span
                  class="legend-dot"
                  style="background: var(--timeline-recovery);"
                ></span>
                Recovery
              </span>
            </div>
            <div class="legend-right" id="youAreHereLabel">
              You are here: 0 min after meal.
            </div>
          </div>

          <div class="microcopy">
            Add meal, sugar, caffeine and timing to see where you sit in the
            0‚Äì240 minute wave.
          </div>

          <div class="crash-times-grid" style="margin-top: 10px;">
            <div>
              <b>Spike window</b>
              <span id="spikeWindowText">Add meal time to see spike window.</span>
            </div>
            <div>
              <b>Crash / anxiety window</b>
              <span id="crashWindowText">Add meal time to see crash window.</span>
            </div>
            <div>
              <b>Recovery trend</b>
              <span id="recoveryWindowText">Add meal time to see recovery.</span>
            </div>
          </div>
        </div>
                <!-- CRASH WINDOW TEXT -->
        <div class="card">
          <div class="card-title">Crash window</div>
          <p class="summary-text" id="crashSummary">
            Once you add a meal and timing, this will show your likely crash / anxiety
            window in clock time.
          </p>
        </div>

        <!-- BODY SNAPSHOT -->
        <div class="card">
          <div class="card-title">Body snapshot</div>
          <p class="summary-text" id="bodySnapshot">
            Once you pick a meal and rough timing, this will summarize how carbs,
            sugar, caffeine and sensitivity are combining in your system.
          </p>
        </div>

        <!-- WHY BUTTON -->
        <div class="card card-tight">
          <button id="whyButton" class="why-card-btn">
            Why am I feeling this way?
          </button>
          <p
            id="whyText"
            class="summary-text"
            style="margin-top: 8px; display: none;"
          >
            This tool is not saying anything is ‚Äúall in your head.‚Äù It is trying to
            show how a heavy carb plate, added sugar and caffeine can create a wave
            that hits the nervous system 1‚Äì4 hours later, especially in people with
            IBS, visceral hypersensitivity or a sensitive anxiety system. If the
            wave lines up with when you usually feel ‚Äúoff,‚Äù that is a clue that timing
            might be part of the story.
          </p>
        </div>
      </div> <!-- /right-column -->
    </div> <!-- /app-grid -->

    <footer>
      ¬© 2025 Darkstar747. Free for personal use and community sharing. Not for
      commercial use, resale, or paywalled distribution. Do not repurpose this
      work for any product or service that charges money.
    </footer>
  </div>
    <script>
    // ---------- MEAL PRESETS ----------

    const presetMeals = [
      // BREAKFAST (about 18)
      { id: 'eggs_toast', label: 'ü•ö Eggs + toast', carbs: 20, sugar: 2, category: 'breakfast' },
      { id: 'omelette', label: 'üç≥ Omelette (veggies/cheese)', carbs: 10, sugar: 2, category: 'breakfast' },
      { id: 'pancakes_syrup', label: 'ü•û Pancakes + syrup', carbs: 65, sugar: 20, category: 'breakfast' },
      { id: 'waffles_syrup', label: 'üßá Waffles + syrup', carbs: 65, sugar: 20, category: 'breakfast' },
      { id: 'bagel_cream_cheese', label: 'ü•Ø Bagel + cream cheese', carbs: 60, sugar: 4, category: 'breakfast' },
      { id: 'cereal_milk', label: 'ü•£ Cereal + milk', carbs: 55, sugar: 15, category: 'breakfast' },
      { id: 'french_toast', label: 'üçû French toast', carbs: 50, sugar: 12, category: 'breakfast' },
      { id: 'bacon_eggs', label: 'ü•ì Bacon + eggs', carbs: 2, sugar: 0, category: 'breakfast' },
      { id: 'egg_cheese_biscuit', label: 'üßÄ Egg & cheese biscuit', carbs: 40, sugar: 3, category: 'breakfast' },
      { id: 'breakfast_burrito', label: 'üåØ Breakfast burrito', carbs: 45, sugar: 3, category: 'breakfast' },
      { id: 'croissant_butter', label: 'ü•ê Croissant w/ butter', carbs: 30, sugar: 4, category: 'breakfast' },
      { id: 'banana_pb', label: 'üçå Banana + peanut butter', carbs: 30, sugar: 14, category: 'breakfast' },
      { id: 'yogurt_fruit', label: 'üç® Yogurt + fruit', carbs: 30, sugar: 18, category: 'breakfast' },
      { id: 'yogurt_granola', label: 'ü•£ Yogurt + granola', carbs: 40, sugar: 20, category: 'breakfast' },
      { id: 'instant_oatmeal', label: 'ü•£ Instant oatmeal', carbs: 35, sugar: 10, category: 'breakfast' },
      { id: 'avocado_toast', label: 'ü•ë Avocado toast', carbs: 25, sugar: 2, category: 'breakfast' },
      { id: 'hash_browns', label: 'ü•î Hash browns', carbs: 25, sugar: 1, category: 'breakfast' },
      { id: 'ham_breakfast_sandwich', label: 'ü•™ Ham breakfast sandwich', carbs: 35, sugar: 4, category: 'breakfast' },

      // LUNCH ‚Äì LIGHT / COMMON (about 16)
      { id: 'turkey_sandwich', label: 'ü•™ Turkey sandwich', carbs: 35, sugar: 4, category: 'lunch_light' },
      { id: 'ham_cheese_sandwich', label: 'ü•™ Ham & cheese sandwich', carbs: 35, sugar: 4, category: 'lunch_light' },
      { id: 'blt_sandwich', label: 'ü•™ BLT sandwich', carbs: 30, sugar: 3, category: 'lunch_light' },
      { id: 'tuna_sandwich', label: 'ü•™ Tuna salad sandwich', carbs: 30, sugar: 3, category: 'lunch_light' },
      { id: 'chicken_caesar_salad', label: 'ü•ó Chicken Caesar salad', carbs: 15, sugar: 3, category: 'lunch_light' },
      { id: 'garden_salad_chicken', label: 'ü•ó Garden salad w/ chicken', carbs: 18, sugar: 4, category: 'lunch_light' },
      { id: 'grilled_cheese', label: 'ü•™ Grilled cheese', carbs: 28, sugar: 3, category: 'lunch_light' },
      { id: 'soup_bread', label: 'üç≤ Soup + bread', carbs: 30, sugar: 3, category: 'lunch_light' },
      { id: 'sushi_light', label: 'üç± Sushi (6‚Äì8 pcs, light sauce)', carbs: 45, sugar: 4, category: 'lunch_light' },
      { id: 'rice_veggies', label: 'üçô Rice + veggies', carbs: 50, sugar: 3, category: 'lunch_light' },
      { id: 'rotisserie_rice', label: 'üçó Rotisserie chicken + rice', carbs: 45, sugar: 2, category: 'lunch_light' },
      { id: 'lentils_rice', label: 'üçõ Lentils + rice', carbs: 55, sugar: 3, category: 'lunch_light' },
      { id: 'baked_potato_loaded', label: 'ü•î Baked potato (loaded)', carbs: 50, sugar: 3, category: 'lunch_light' },
      { id: 'chicken_salad', label: 'ü•ó Chicken salad (light croutons)', carbs: 20, sugar: 3, category: 'lunch_light' },
      { id: 'small_mac_cheese', label: 'üçù Mac & cheese (small bowl)', carbs: 40, sugar: 3, category: 'lunch_light' },
      { id: 'sushi_california_roll', label: 'üç£ California roll', carbs: 35, sugar: 3, category: 'lunch_light' },

      // LUNCH ‚Äì HEAVIER / FAST FOOD (about 18)
      { id: 'cheeseburger', label: 'üçî Cheeseburger', carbs: 40, sugar: 8, category: 'lunch_heavy' },
      { id: 'double_cheeseburger', label: 'üçî Double cheeseburger', carbs: 45, sugar: 8, category: 'lunch_heavy' },
      { id: 'bacon_burger', label: 'üçî Bacon burger', carbs: 45, sugar: 8, category: 'lunch_heavy' },
      { id: 'burger_fries_combo', label: 'üçî Burger + fries combo', carbs: 75, sugar: 10, category: 'lunch_heavy' },
      { id: 'taco_combo_3', label: 'üåÆ Taco combo (3)', carbs: 60, sugar: 5, category: 'lunch_heavy' },
      { id: 'burrito_rice_beans', label: 'üåØ Burrito (rice + beans)', carbs: 85, sugar: 5, category: 'lunch_heavy' },
      { id: 'big_burrito_chipotle', label: 'üåØ Big burrito (chipotle-style)', carbs: 95, sugar: 6, category: 'lunch_heavy' },
      { id: 'pizza_2_slices', label: 'üçï Pizza (2 slices)', carbs: 60, sugar: 5, category: 'lunch_heavy' },
      { id: 'pizza_3_slices', label: 'üçï Pizza (3 slices)', carbs: 90, sugar: 8, category: 'lunch_heavy' },
      { id: 'fried_chicken_2pc', label: 'üçó Fried chicken (2 pieces)', carbs: 20, sugar: 1, category: 'lunch_heavy' },
      { id: 'chicken_tenders_5', label: 'üçó Chicken tenders (5)', carbs: 30, sugar: 2, category: 'lunch_heavy' },
      { id: 'ramen_bowl', label: 'üçú Ramen bowl', carbs: 65, sugar: 4, category: 'lunch_heavy' },
      { id: 'teriyaki_chicken_rice', label: 'üç± Teriyaki chicken + rice', carbs: 75, sugar: 18, category: 'lunch_heavy' },
      { id: 'hibachi_chicken_rice', label: 'üç± Hibachi chicken + rice', carbs: 70, sugar: 8, category: 'lunch_heavy' },
      { id: 'sub_12in', label: 'ü•ñ Sub sandwich (12")', carbs: 70, sugar: 7, category: 'lunch_heavy' },
      { id: 'quesadilla_rice', label: 'üåØ Quesadilla + rice', carbs: 70, sugar: 4, category: 'lunch_heavy' },
      { id: 'wings_6', label: 'üçó Wings (6)', carbs: 12, sugar: 4, category: 'lunch_heavy' },
      { id: 'lo_mein_combo', label: 'üçú Lo mein combo', carbs: 85, sugar: 10, category: 'lunch_heavy' },

      // DINNER ‚Äì HOME CLASSICS (about 18)
      { id: 'chicken_rice_veg', label: 'üçó Chicken + rice + veg', carbs: 55, sugar: 4, category: 'dinner' },
      { id: 'baked_chicken_potatoes', label: 'üçó Baked chicken + potatoes', carbs: 45, sugar: 3, category: 'dinner' },
      { id: 'steak_potatoes', label: 'ü•© Steak + potatoes', carbs: 40, sugar: 2, category: 'dinner' },
      { id: 'salmon_rice', label: 'üêü Salmon + rice', carbs: 45, sugar: 2, category: 'dinner' },
      { id: 'fish_veggies', label: 'üêü Baked fish + veggies', carbs: 20, sugar: 2, category: 'dinner' },
      { id: 'beef_stew', label: 'üç≤ Beef stew', carbs: 35, sugar: 4, category: 'dinner' },
      { id: 'pork_chops_sides', label: 'üçñ Pork chops + sides', carbs: 35, sugar: 4, category: 'dinner' },
      { id: 'chili_cornbread', label: 'üçõ Chili + cornbread', carbs: 55, sugar: 6, category: 'dinner' },
      { id: 'stir_fry_rice', label: 'üçö Stir fry + rice', carbs: 65, sugar: 8, category: 'dinner' },
      { id: 'noodles_veggies', label: 'üçú Noodles + veggies', carbs: 60, sugar: 4, category: 'dinner' },
      { id: 'lasagna', label: 'üçù Lasagna', carbs: 60, sugar: 6, category: 'dinner' },
      { id: 'pasta_marinara', label: 'üçù Pasta + marinara', carbs: 70, sugar: 8, category: 'dinner' },
      { id: 'pasta_meatballs', label: 'üçù Pasta + meatballs', carbs: 75, sugar: 8, category: 'dinner' },
      { id: 'taco_night_3', label: 'üåÆ Taco night (3)', carbs: 60, sugar: 5, category: 'dinner' },
      { id: 'fajitas', label: 'üåØ Fajitas (tortillas + fillings)', carbs: 55, sugar: 4, category: 'dinner' },
      { id: 'bbq_ribs_sides', label: 'üçñ BBQ ribs + sides', carbs: 55, sugar: 18, category: 'dinner' },
      { id: 'meatloaf_potatoes', label: 'üçó Meatloaf + potatoes', carbs: 45, sugar: 6, category: 'dinner' },
      { id: 'shepherd_pie', label: 'ü•ò Shepherd‚Äôs pie', carbs: 55, sugar: 4, category: 'dinner' },

      // ASIAN / INTERNATIONAL FAVORITES (about 15)
      { id: 'pho', label: 'üçú Pho noodles', carbs: 60, sugar: 4, category: 'asian' },
      { id: 'udon', label: 'üçú Udon bowl', carbs: 55, sugar: 4, category: 'asian' },
      { id: 'pad_thai', label: 'üçú Pad Thai', carbs: 75, sugar: 18, category: 'asian' },
      { id: 'tom_yum', label: 'üç≤ Tom yum soup', carbs: 20, sugar: 3, category: 'asian' },
      { id: 'thai_curry_rice', label: 'üçõ Thai curry + rice', carbs: 70, sugar: 6, category: 'asian' },
      { id: 'indian_curry_naan', label: 'üçõ Indian curry + naan', carbs: 80, sugar: 6, category: 'asian' },
      { id: 'dumplings_8', label: 'ü•ü Dumplings (8)', carbs: 45, sugar: 3, category: 'asian' },
      { id: 'gyoza_6', label: 'ü•ü Gyoza (6)', carbs: 30, sugar: 2, category: 'asian' },
      { id: 'fried_rice', label: 'üçö Fried rice (one plate)', carbs: 70, sugar: 4, category: 'asian' },
      { id: 'chicken_katsu_rice', label: 'üçö Chicken katsu + rice', carbs: 75, sugar: 6, category: 'asian' },
      { id: 'butter_chicken_rice', label: 'üçõ Butter chicken + rice', carbs: 70, sugar: 8, category: 'asian' },
      { id: 'butter_paneer_rice', label: 'üçõ Butter paneer + rice', carbs: 70, sugar: 8, category: 'asian' },
      { id: 'korean_bbq_plate', label: 'ü•ò Korean BBQ plate (rice + sides)', carbs: 60, sugar: 10, category: 'asian' },
      { id: 'yakitori_skewers_rice', label: 'üç¢ Yakitori chicken + rice', carbs: 50, sugar: 5, category: 'asian' },
      { id: 'tempura_shrimp_6', label: 'üç§ Tempura shrimp (6)', carbs: 35, sugar: 2, category: 'asian' },

      // AMERICAN HEAVY / SAUCY (about 10)
      { id: 'large_pizza_slice', label: 'üçï Large pizza slice', carbs: 45, sugar: 4, category: 'american_heavy' },
      { id: 'meat_lovers_pizza_2', label: 'üçï Meat lovers (2 slices)', carbs: 70, sugar: 6, category: 'american_heavy' },
      { id: 'alfredo_garlic_bread', label: 'üçù Alfredo + garlic bread', carbs: 90, sugar: 6, category: 'american_heavy' },
      { id: 'spaghetti_garlic_knots', label: 'üçù Spaghetti + garlic knots', carbs: 95, sugar: 8, category: 'american_heavy' },
      { id: 'hot_dog_chips', label: 'üå≠ Hot dog + chips', carbs: 45, sugar: 4, category: 'american_heavy' },
      { id: 'philly_cheesesteak', label: 'ü•™ Philly cheesesteak', carbs: 55, sugar: 6, category: 'american_heavy' },
      { id: 'buffalo_wings_8', label: 'üçó Buffalo wings (8)', carbs: 15, sugar: 4, category: 'american_heavy' },
      { id: 'loaded_fries', label: 'üçü Loaded fries', carbs: 60, sugar: 3, category: 'american_heavy' },
      { id: 'chicken_fried_steak', label: 'ü•ö Chicken fried steak + gravy', carbs: 55, sugar: 3, category: 'american_heavy' },
      { id: 'jambalaya', label: 'ü•ò Jambalaya', carbs: 50, sugar: 4, category: 'american_heavy' },

      // SNACKS / SMALL EATS (about 12)
      { id: 'large_cookie', label: 'üç™ Large cookie', carbs: 30, sugar: 20, category: 'snack' },
      { id: 'candy_bar', label: 'üç´ Candy bar', carbs: 35, sugar: 25, category: 'snack' },
      { id: 'donut', label: 'üç© Donut', carbs: 30, sugar: 18, category: 'snack' },
      { id: 'chips_bag', label: 'ü•® Chips (snack bag)', carbs: 18, sugar: 1, category: 'snack' },
      { id: 'popcorn_butter', label: 'üçø Popcorn (butter)', carbs: 25, sugar: 0, category: 'snack' },
      { id: 'soft_pretzel', label: 'ü•® Soft pretzel', carbs: 40, sugar: 4, category: 'snack' },
      { id: 'small_fries', label: 'üçü Small fries', carbs: 30, sugar: 0, category: 'snack' },
      { id: 'trail_mix', label: 'ü•ú Peanut trail mix', carbs: 20, sugar: 8, category: 'snack' },
      { id: 'banana_snack', label: 'üçå Banana (snack)', carbs: 27, sugar: 14, category: 'snack' },
      { id: 'apple_slices', label: 'üçé Apple slices', carbs: 20, sugar: 15, category: 'snack' },
      { id: 'taquito', label: 'üåØ Taquito', carbs: 20, sugar: 1, category: 'snack' },
      { id: 'rice_crispy', label: 'üç∞ Rice crispy treat', carbs: 28, sugar: 16, category: 'snack' },

      // DESSERTS (about 12)
      { id: 'cheesecake_slice', label: 'üç∞ Cheesecake slice', carbs: 40, sugar: 28, category: 'dessert' },
      { id: 'chocolate_cake', label: 'üç∞ Chocolate cake', carbs: 45, sugar: 30, category: 'dessert' },
      { id: 'vanilla_cupcake', label: 'üßÅ Vanilla cupcake', carbs: 30, sugar: 24, category: 'dessert' },
      { id: 'apple_pie', label: 'ü•ß Apple pie slice', carbs: 40, sugar: 24, category: 'dessert' },
      { id: 'pumpkin_pie', label: 'ü•ß Pumpkin pie slice', carbs: 38, sugar: 22, category: 'dessert' },
      { id: 'ice_cream_bowl', label: 'üç¶ Ice cream bowl', carbs: 30, sugar: 26, category: 'dessert' },
      { id: 'ice_cream_sundae', label: 'üç® Ice cream sundae', carbs: 40, sugar: 32, category: 'dessert' },
      { id: 'brownie', label: 'üç´ Brownie', carbs: 35, sugar: 28, category: 'dessert' },
      { id: 'mochi_ice_cream', label: 'üç° Mochi ice cream (2)', carbs: 30, sugar: 18, category: 'dessert' },
      { id: 'tiramisu', label: 'üç∞ Tiramisu', carbs: 40, sugar: 26, category: 'dessert' },
      { id: 'cupcake_chocolate', label: 'üßÅ Chocolate cupcake', carbs: 32, sugar: 26, category: 'dessert' },
      { id: 'rice_pudding', label: 'ü•õ Rice pudding', carbs: 35, sugar: 20, category: 'dessert' }
    ];
          // Helper: group meals by category for headings
    const categoryLabels = {
      breakfast: "Breakfast",
      lunch_light: "Lunch ‚Äì lighter plates",
      lunch_heavy: "Lunch ‚Äì heavier / fast food",
      dinner: "Dinner plates",
      asian: "Asian / international",
      american_heavy: "American heavy / saucy",
      snack: "Snacks / small eats",
      dessert: "Desserts"
    };

    // ---------- STATE ----------

    const state = {
      selectedMealId: null,
      mealCarbs: 0,
      mealSugar: 0,
      dessertSugar: 0,
      sugaryDrinkSugar: 0,
      caffeineMg: 0,
      sodaCaffeineMg: 0,
      dayCarb: 1,
      visceral: 1,
      anxiety: 1,
      minutesSince: 0,
      mealClockTime: null // Date object today or null
    };

    // ---------- DOM REFS ----------

    const mealPresetsContainer = document.getElementById("mealPresetsContainer");
    const mealSearchInput = document.getElementById("mealSearchInput");
    const clearMealSearchBtn = document.getElementById("clearMealSearchBtn");
    const selectedMealLabel = document.getElementById("selectedMealLabel");

    const dessertRow = document.getElementById("dessertRow");
    const sugaryDrinkRow = document.getElementById("sugaryDrinkRow");
    const caffeineRow = document.getElementById("caffeineRow");
    const sodaCaffeineRow = document.getElementById("sodaCaffeineRow");
    const dayCarbRow = document.getElementById("dayCarbRow");
    const visceralRow = document.getElementById("visceralRow");
    const anxietyRow = document.getElementById("anxietyRow");

    const mealTimeInput = document.getElementById("mealTimeInput");
    const minutesSinceMealRange = document.getElementById("minutesSinceMealRange");
    const minutesSinceLabel = document.getElementById("minutesSinceLabel");

    const scoreBig = document.getElementById("scoreBig");
    const scoreStatusText = document.getElementById("scoreStatusText");
    const scoreCategoryPill = document.getElementById("scoreCategoryPill");
    const riskGaugeIndicator = document.getElementById("riskGaugeIndicator");

    const timelineYouLine = document.getElementById("timelineYouLine");
    const youAreHereLabel = document.getElementById("youAreHereLabel");
    const spikeWindowText = document.getElementById("spikeWindowText");
    const crashWindowText = document.getElementById("crashWindowText");
    const recoveryWindowText = document.getElementById("recoveryWindowText");

    const crashSummary = document.getElementById("crashSummary");
    const bodySnapshot = document.getElementById("bodySnapshot");

    const whyButton = document.getElementById("whyButton");
    const whyText = document.getElementById("whyText");

    // ---------- RENDER MEAL PRESETS ----------

    function renderMealPresets(filterText = "") {
      const text = filterText.trim().toLowerCase();
      mealPresetsContainer.innerHTML = "";

      const byCategory = {};
      for (const meal of presetMeals) {
        if (
          text &&
          !meal.label.toLowerCase().includes(text) &&
          !meal.id.toLowerCase().includes(text)
        ) {
          continue;
        }
        if (!byCategory[meal.category]) byCategory[meal.category] = [];
        byCategory[meal.category].push(meal);
      }

      Object.keys(categoryLabels).forEach((catKey) => {
        const items = byCategory[catKey];
        if (!items || items.length === 0) return;

        const catLabel = document.createElement("div");
        catLabel.className = "meal-category-label";
        catLabel.textContent = categoryLabels[catKey];
        mealPresetsContainer.appendChild(catLabel);

        const grid = document.createElement("div");
        grid.className = "meal-badges-grid";

        items.forEach((meal) => {
          const pill = document.createElement("button");
          pill.type = "button";
          pill.className =
            "meal-pill" + (meal.id === state.selectedMealId ? " active" : "");
          pill.dataset.mealId = meal.id;

          const title = document.createElement("div");
          title.className = "meal-pill-title";
          title.textContent = meal.label;
          pill.appendChild(title);

          const sub = document.createElement("div");
          sub.className = "meal-pill-sub";
          sub.textContent = `${meal.carbs} g carbs ¬∑ ~${meal.sugar} g sugar`;
          pill.appendChild(sub);

          const tag = document.createElement("div");
          tag.className = "meal-pill-tag";
          let tagText = "";
          if (meal.carbs >= 80) tagText = "Very high carb plate";
          else if (meal.carbs >= 60) tagText = "High carb plate";
          else if (meal.carbs >= 40) tagText = "Medium carb plate";
          else tagText = "Lighter carb plate";
          tag.textContent = tagText;
          pill.appendChild(tag);

          pill.addEventListener("click", () => {
            state.selectedMealId = meal.id;
            state.mealCarbs = meal.carbs;
            state.mealSugar = meal.sugar;
            selectedMealLabel.textContent = `Selected meal: ${meal.label}`;
            renderMealPresets(mealSearchInput.value);
            recompute();
          });

          grid.appendChild(pill);
        });

        mealPresetsContainer.appendChild(grid);
      });

      if (!mealPresetsContainer.innerHTML.trim()) {
        const empty = document.createElement("div");
        empty.style.fontSize = "12px";
        empty.style.color = "var(--text-soft)";
        empty.textContent = "No meals match this search yet.";
        mealPresetsContainer.appendChild(empty);
      }
    }

    renderMealPresets();

    mealSearchInput.addEventListener("input", () => {
      renderMealPresets(mealSearchInput.value);
    });

    clearMealSearchBtn.addEventListener("click", () => {
      mealSearchInput.value = "";
      renderMealPresets("");
    });

    // ---------- HELPERS FOR PILL ROWS ----------

    function wirePillRow(rowEl, key, attrName, defaultValue) {
      const pills = Array.from(rowEl.querySelectorAll(".pill"));

      function setFromValue(v) {
        state[key] = v;
        pills.forEach((pill) => {
          const val = Number(pill.dataset[attrName]);
          pill.classList.toggle("active", val === v);
        });
      }

      pills.forEach((pill) => {
        pill.addEventListener("click", () => {
          const v = Number(pill.dataset[attrName]);
          setFromValue(v);
          recompute();
        });
      });

      setFromValue(defaultValue);
    }

    wirePillRow(dessertRow, "dessertSugar", "dessert", 0);
    wirePillRow(sugaryDrinkRow, "sugaryDrinkSugar", "sugardrink", 0);
    wirePillRow(caffeineRow, "caffeineMg", "caffeine", 0);
    wirePillRow(sodaCaffeineRow, "sodaCaffeineMg", "sodacaf", 0);
    wirePillRow(dayCarbRow, "dayCarb", "daycarb", 1);
    wirePillRow(visceralRow, "visceral", "visceral", 1);
    wirePillRow(anxietyRow, "anxiety", "anxiety", 1);

    // ---------- TIME INPUTS ----------

    function parseMealTimeToToday(timeStr) {
      if (!timeStr) return null;
      const [hStr, mStr] = timeStr.split(":");
      if (hStr == null || mStr == null) return null;
      const d = new Date();
      d.setHours(Number(hStr), Number(mStr), 0, 0);
      return d;
    }

    function formatTimeRange(d1, d2) {
      if (!d1 || !d2) return "Add meal time to see this window.";
      const opts = { hour: "numeric", minute: "2-digit" };
      return `${d1.toLocaleTimeString([], opts)} ‚Äì ${d2.toLocaleTimeString([], opts)}`;
    }

    mealTimeInput.addEventListener("input", () => {
      state.mealClockTime = parseMealTimeToToday(mealTimeInput.value);
      recompute();
    });

    minutesSinceMealRange.addEventListener("input", () => {
      state.minutesSince = Number(minutesSinceMealRange.value);
      minutesSinceLabel.textContent = `${state.minutesSince} minutes since meal.`;
      recompute();
    });

    // ---------- BIO-INSPIRED MATH ----------

    function clamp(x, min, max) {
      return Math.max(min, Math.min(max, x));
    }

    function computeScore() {
      const totalCarbs = state.mealCarbs;
      const totalSugar =
        state.mealSugar + state.dessertSugar + state.sugaryDrinkSugar;
      const totalCaffeine = state.caffeineMg + state.sodaCaffeineMg;

      // Carb load 0‚Äì1.3
      let carbFactor = (totalCarbs - 20) / 80;
      carbFactor = clamp(carbFactor, 0, 1.3);

      // Sugar load 0‚Äì1.2
      let sugarFactor = totalSugar / 40;
      sugarFactor = clamp(sugarFactor, 0, 1.2);

      // Caffeine load 0‚Äì1
      let caffeineFactor = totalCaffeine / 150;
      caffeineFactor = clamp(caffeineFactor, 0, 1.0);

      // Stacking from rest of day carbs 0‚Äì0.6
      const stacking = [0, 0.3, 0.6][state.dayCarb] ?? 0.3;

      // Sensitivity factors
      const visceralMul = [0.85, 1.0, 1.25][state.visceral] ?? 1.0;
      const anxietyMul = [0.85, 1.0, 1.25][state.anxiety] ?? 1.0;
      const sensitivityMul = visceralMul * anxietyMul;

      // Base metabolic load 0‚Äì1.8
      const baseLoad =
        0.6 * carbFactor + 0.25 * sugarFactor + 0.15 * caffeineFactor + stacking;
      const load = clamp(baseLoad, 0, 1.8);

      // Time weighting 0‚Äì1, peak around 90‚Äì100 minutes
      const t = clamp(state.minutesSince / 240, 0, 1);
      let timeWeight = 0;
      if (state.minutesSince <= 0) {
        timeWeight = 0;
      } else {
        const center = 0.4; // ~96 minutes
        const spread = 0.18;
        const z = (t - center) / spread;
        timeWeight = Math.exp(-0.5 * z * z);
      }

      const raw = 100 * load * timeWeight * sensitivityMul;
      return clamp(raw, 0, 100);
    }

    function categoryForScore(score) {
      if (score >= 75) return "high";
      if (score >= 50) return "moderate";
      return "low";
    }

    function statusTextForScore(score) {
      if (score < 10)
        return "Very low wave activity right now.";
      if (score < 25)
        return "Low-level wave; most people barely notice this.";
      if (score < 50)
        return "Mild wave; sensitive guts may feel a small dip.";
      if (score < 75)
        return "Moderate crash window; anxiety-prone systems may feel this.";
      return "High crash window; sensitive people may feel wired, shaky or off.";
    }

    // ---------- UPDATE UI ----------

    function recompute() {
      const score = Math.round(computeScore());
      scoreBig.textContent = score.toString();
      const cat = categoryForScore(score);

      scoreCategoryPill.textContent =
        cat === "high" ? "High" : cat === "moderate" ? "Moderate" : "Low";
      scoreCategoryPill.classList.remove("low", "moderate", "high");
      scoreCategoryPill.classList.add(cat);

      scoreStatusText.textContent = statusTextForScore(score);

      // Gauge indicator position
      const pct = score / 100;
      const barWidth = riskGaugeIndicator.parentElement.clientWidth || 1;
      const leftPx = clamp(pct * barWidth, 0, barWidth) - 1;
      riskGaugeIndicator.style.left = `${leftPx}px`;

      // Timeline line position
      const tPct = clamp(state.minutesSince / 240, 0, 1);
      const barWidth2 = timelineYouLine.parentElement.clientWidth || 1;
      const leftPx2 = clamp(tPct * barWidth2, 0, barWidth2) - 1;
      timelineYouLine.style.left = `${leftPx2}px`;
      youAreHereLabel.textContent = `You are here: ${state.minutesSince} min after meal.`;

      // Crash windows in clock time
      if (!state.mealClockTime) {
        spikeWindowText.textContent = "Add meal time to see spike window.";
        crashWindowText.textContent = "Add meal time to see crash window.";
        recoveryWindowText.textContent = "Add meal time to see recovery.";
      } else {
        const base = state.mealClockTime;
        const ms = 60 * 1000;

        const spikeStart = new Date(base.getTime() + 20 * ms);
        const spikeEnd = new Date(base.getTime() + 60 * ms);
        const crashStart = new Date(base.getTime() + 60 * ms);
        const crashEnd = new Date(base.getTime() + 120 * ms);
        const recStart = new Date(base.getTime() + 120 * ms);
        const recEnd = new Date(base.getTime() + 240 * ms);

        spikeWindowText.textContent = formatTimeRange(spikeStart, spikeEnd);
        crashWindowText.textContent = formatTimeRange(crashStart, crashEnd);
        recoveryWindowText.textContent = formatTimeRange(recStart, recEnd);
      }

      // Crash summary
      if (!state.selectedMealId) {
        crashSummary.textContent =
          "Once you add a meal and timing, this will show your likely crash / anxiety window in clock time.";
        bodySnapshot.textContent =
          "Once you pick a meal and rough timing, this will summarize how carbs, sugar, caffeine and sensitivity are combining in your system.";
        return;
      }

      const intensity =
        cat === "high"
          ? "a strong wave"
          : cat === "moderate"
          ? "a moderate wave"
          : "a gentle wave";

      const windowNote = state.mealClockTime
        ? "Check the crash window above for roughly when this tends to peak for you."
        : "If you add an approximate meal time, this will show the likely crash window in clock time.";

      crashSummary.textContent =
        `${score}/100 risk in the crash window after this meal. ` +
        `This suggests ${intensity} built from this plate, plus dessert, drinks and your sensitivity. ` +
        windowNote;

      const gutWords =
        state.visceral === 2
          ? "a gut that feels every bubble and stretch"
          : state.visceral === 0
          ? "a gut that usually stays quiet"
          : "a medium-sensitive gut";

      const anxietyWords =
        state.anxiety === 2
          ? "a nervous system that notices every little dip"
          : state.anxiety === 0
          ? "a fairly calm nervous system"
          : "a somewhat sensitive nervous system";

      const dayCarbWords =
        state.dayCarb === 2
          ? "stacking on top of a carb-heavy day"
          : state.dayCarb === 0
          ? "on a mostly light-carb day"
          : "on a medium carb day";

      bodySnapshot.textContent =
        `This estimate is built from a ${totalCarbsDescription(
          state.mealCarbs
        )}, about ${Math.round(
          state.mealSugar + state.dessertSugar + state.sugaryDrinkSugar
        )} g of sugar, and roughly ${Math.round(
          state.caffeineMg + state.sodaCaffeineMg
        )} mg of caffeine, ${dayCarbWords}. ` +
        `It assumes ${gutWords} and ${anxietyWords}. ` +
        `It is just a timing map; it is not a diagnosis or a replacement for real medical care.`;
    }

    function totalCarbsDescription(carbs) {
      if (carbs >= 90) return "very heavy carb plate";
      if (carbs >= 70) return "high-carb plate";
      if (carbs >= 50) return "medium-carb plate";
      if (carbs >= 30) return "lighter plate";
      return "very light carb plate";
    }

    // Why button
    whyButton.addEventListener("click", () => {
      const visible = whyText.style.display === "block";
      whyText.style.display = visible ? "none" : "block";
    });

    // Initial compute
    recompute();
  </script>
</body>
</html>
