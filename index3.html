<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Carb / Sugar Anxiety Timing Explorer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Biology-based timing explorer for carb, sugar, and caffeine spikes that can lead to anxiety windows, especially in sensitive guts.">
  <style>
    :root {
      font-family: -apple-system, BlinkMacSystemFont, system-ui, -system-ui, "Segoe UI", sans-serif;
      background-color: #050505;
      color: #d0d0d0;
      line-height: 1.5;
    }
    body {
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top left, #1c272f, #050505 55%);
    }
    main {
      max-width: 900px;
      margin: 0 auto;
      padding: 18px 16px 40px;
    }
    h1, h2, h3 {
      font-weight: 600;
      color: #f5f5f5;
      margin-top: 0;
    }
    h1 {
      font-size: 1.7rem;
      margin-bottom: 0.25rem;
    }
    h2 {
      font-size: 1.25rem;
      margin-top: 2rem;
    }
    p {
      margin: 0.25rem 0 0.5rem;
    }
    small {
      color: #9a9a9a;
    }
    section {
      margin-top: 1.75rem;
      padding: 1.1rem 1rem;
      border-radius: 12px;
      background: rgba(10, 10, 10, 0.9);
      border: 1px solid #262626;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.6);
    }
    .pill-row {
      display: inline-flex;
      gap: 4px;
      padding: 3px;
      border-radius: 999px;
      background: #111111;
      border: 1px solid #333333;
      margin: 0.4rem 0 0.6rem;
    }
    .pill-row button {
      border: none;
      border-radius: 999px;
      padding: 5px 10px;
      font-size: 0.8rem;
      background: transparent;
      color: #bfbfbf;
      cursor: pointer;
      transition: background 0.15s ease, color 0.15s ease;
      white-space: nowrap;
    }
    .pill-row button.active {
      background: linear-gradient(135deg, #38bdf8, #6366f1);
      color: white;
    }
    .field-group {
      margin-top: 0.75rem;
    }
    .field-label {
      font-size: 0.85rem;
      font-weight: 500;
      color: #f0f0f0;
      margin-bottom: 0.25rem;
    }
    .helper-text {
      font-size: 0.78rem;
      color: #9a9a9a;
      margin-bottom: 0.3rem;
    }
    .meal-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 0.5rem;
      margin-top: 0.4rem;
    }
    .meal-card {
      position: relative;
      border-radius: 10px;
      border: 1px solid #333333;
      padding: 8px 9px;
      background: radial-gradient(circle at top left, #111821, #050608);
      cursor: pointer;
      display: flex;
      gap: 8px;
      align-items: flex-start;
      font-size: 0.82rem;
    }
    .meal-card input {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }
    .meal-card .emoji {
      font-size: 1.15rem;
    }
    .meal-card .meal-main {
      flex: 1;
      min-width: 0;
    }
    .meal-title {
      font-weight: 500;
      color: #f3f3f3;
    }
    .meal-meta {
      font-size: 0.75rem;
      color: #a3a3a3;
    }
    .meal-tag {
      font-size: 0.72rem;
      color: #f97316;
      margin-top: 2px;
    }
    .meal-card.selected {
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px #0ea5e9;
    }
    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 0.25rem;
    }
    .chip {
      border-radius: 999px;
      border: 1px solid #333333;
      padding: 3px 9px;
      font-size: 0.78rem;
      background: #080808;
      color: #c8c8c8;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .chip input {
      display: none;
    }
    .chip.active {
      border-color: #22c55e;
      background: radial-gradient(circle at top left, #064e3b, #020617);
      color: #ecfdf5;
    }
    .chip-danger.active {
      border-color: #ef4444;
      background: radial-gradient(circle at top left, #7f1d1d, #020617);
      color: #fee2e2;
    }
    .chip-soft.active {
      border-color: #38bdf8;
      background: radial-gradient(circle at top left, #082f49, #020617);
      color: #e0f2fe;
    }
    .inline-button {
      font-size: 0.78rem;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      cursor: pointer;
      margin-top: 0.25rem;
    }
    .inline-button:hover {
      background: #0f172a;
    }
    .time-input-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    .time-input-row input[type="time"] {
      background: #020617;
      border-radius: 8px;
      border: 1px solid #374151;
      padding: 4px 8px;
      color: #e5e7eb;
      font-size: 0.78rem;
    }
    input[type="number"] {
      width: 100%;
      max-width: 160px;
      background: #020617;
      border-radius: 8px;
      border: 1px solid #374151;
      padding: 4px 8px;
      color: #e5e7eb;
      font-size: 0.82rem;
    }
    .columns-2 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1rem;
    }
    @media (max-width: 640px) {
      section {
        padding: 0.95rem 0.8rem;
      }
      .meal-cards {
        grid-template-columns: 1fr;
      }
    }
    /* Risk gauge */
    .risk-scale {
      display: flex;
      justify-content: space-between;
      font-size: 0.76rem;
      color: #9ca3af;
      margin-bottom: 0.35rem;
    }
    .risk-bar {
      position: relative;
      width: 100%;
      height: 14px;
      border-radius: 999px;
      background: linear-gradient(90deg, #16a34a 0%, #facc15 50%, #ef4444 100%);
      overflow: hidden;
      box-shadow: 0 0 0 1px #111827;
    }
    .risk-bar-fill {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 0%;
      background: rgba(15, 23, 42, 0.25);
      border-right: 2px solid #e5e7eb;
      transition: width 0.25s ease-out;
    }
    .risk-score-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-top: 0.45rem;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    .risk-score-row span {
      font-size: 0.84rem;
    }
    .risk-score-main {
      font-weight: 500;
      font-size: 0.92rem;
      color: #f9fafb;
    }
    .risk-chip {
      padding: 2px 7px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 500;
      border: 1px solid #4b5563;
    }
    .risk-chip.low {
      border-color: #16a34a;
      color: #bbf7d0;
    }
    .risk-chip.moderate {
      border-color: #facc15;
      color: #fef9c3;
    }
    .risk-chip.high {
      border-color: #ef4444;
      color: #fee2e2;
    }
    .muted {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-top: 0.25rem;
    }
    /* Timeline */
    .timeline-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 0.9rem;
      margin-top: 0.4rem;
    }
    .timeline-card {
      border-radius: 10px;
      border: 1px solid #1f2933;
      padding: 0.7rem 0.75rem;
      background: radial-gradient(circle at top left, #020617, #020617 40%, #000000);
      font-size: 0.8rem;
    }
    .timeline-label {
      font-size: 0.76rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #9ca3af;
      margin-bottom: 0.15rem;
    }
    .timeline-main {
      font-size: 0.84rem;
      color: #e5e7eb;
    }
    .timeline-detail {
      font-size: 0.78rem;
      color: #9ca3af;
      margin-top: 0.2rem;
    }
    .summary-bullet {
      font-size: 0.82rem;
      margin-top: 0.25rem;
    }
  </style>
</head>
<body>
<main>
  <header>
    <h1>Carb / Sugar Anxiety Timing Explorer</h1>
    <p>Focus on post-meal hours, not psychology. Built for sensitive gut and nervous system people.</p>
    <p class="muted">
      Rough, biology-informed estimate of when carbs, added sugar, and caffeine might create a spike - crash - anxiety window.
      Not medical advice, just a pattern explorer.
    </p>
  </header>

  <section id="meal-section">
    <h2>Meal and pattern</h2>
    <p class="muted">Fill this in and the gauge, timeline, and summary will adjust automatically.</p>

    <div class="pill-row" role="tablist">
      <button id="simpleModeBtn" class="active" type="button">Simple (pick a meal)</button>
      <button id="advancedModeBtn" type="button">Advanced (exact grams)</button>
    </div>

    <div id="simpleModePanel">
      <div class="field-group">
        <div class="field-label">Simple: what did the meal look like?</div>
        <button id="clearSimpleBtn" class="inline-button" type="button">Clear desserts and drinks</button>
        <p id="selectedMealText" class="helper-text">
          Selected meal: Plate of pasta (default)
        </p>
        <p class="helper-text">
          Tap the option that feels closest. You can still tweak sugar, caffeine, and sensitivity below.
        </p>

        <div class="meal-cards">
          <!-- High carb dinner style -->
          <label class="meal-card selected">
            <input type="radio" name="mealPreset" value="pasta" data-carbs="80" checked>
            <div class="emoji">üçù</div>
            <div class="meal-main">
              <div class="meal-title">Plate of pasta</div>
              <div class="meal-meta">Dinner, Italian</div>
              <div class="meal-tag">High carb</div>
            </div>
          </label>

          <label class="meal-card">
            <input type="radio" name="mealPreset" value="riceBowl" data-carbs="70">
            <div class="emoji">üçö</div>
            <div class="meal-main">
              <div class="meal-title">Rice bowl</div>
              <div class="meal-meta">Lunch or dinner</div>
              <div class="meal-tag">High carb</div>
            </div>
          </label>

          <label class="meal-card">
            <input type="radio" name="mealPreset" value="ramen" data-carbs="65">
            <div class="emoji">üçú</div>
            <div class="meal-main">
              <div class="meal-title">Ramen or noodle bowl</div>
              <div class="meal-meta">Dinner, noodles</div>
              <div class="meal-tag">High carb + salt</div>
            </div>
          </label>

          <label class="meal-card">
            <input type="radio" name="mealPreset" value="friedRice" data-carbs="75">
            <div class="emoji">üçõ</div>
            <div class="meal-main">
              <div class="meal-title">Fried rice</div>
              <div class="meal-meta">Takeout, Chinese</div>
              <div class="meal-tag">High carb + fat</div>
            </div>
          </label>

          <!-- Fast food / mixed meals -->
          <label class="meal-card">
            <input type="radio" name="mealPreset" value="burgerFries" data-carbs="65">
            <div class="emoji">üçî</div>
            <div class="meal-main">
              <div class="meal-title">Burger and fries</div>
              <div class="meal-meta">Fast food combo</div>
              <div class="meal-tag">Carb + fat stack</div>
            </div>
          </label>

          <label class="meal-card">
            <input type="radio" name="mealPreset" value="pizza" data-carbs="60">
            <div class="emoji">üçï</div>
            <div class="meal-main">
              <div class="meal-title">Pizza (2‚Äì3 slices)</div>
              <div class="meal-meta">Takeout, dinner</div>
              <div class="meal-tag">Refined flour + fat</div>
            </div>
          </label>

          <label class="meal-card">
            <input type="radio" name="mealPreset" value="tacos" data-carbs="50">
            <div class="emoji">üåÆ</div>
            <div class="meal-main">
              <div class="meal-title">3 tacos</div>
              <div class="meal-meta">Street or fast food</div>
              <div class="meal-tag">Moderate carb</div>
            </div>
          </label>

          <!-- Breakfast / lighter -->
          <label class="meal-card">
            <input type="radio" name="mealPreset" value="cereal" data-carbs="55">
            <div class="emoji">ü•£</div>
            <div class="meal-main">
              <div class="meal-title">Cereal and milk</div>
              <div class="meal-meta">Breakfast</div>
              <div class="meal-tag">Refined carbs</div>
            </div>
          </label>

          <label class="meal-card">
            <input type="radio" name="mealPreset" value="oatmeal" data-carbs="45">
            <div class="emoji">üåæ</div>
            <div class="meal-main">
              <div class="meal-title">Oatmeal bowl</div>
              <div class="meal-meta">With a bit of fruit</div>
              <div class="meal-tag">Slower carbs</div>
            </div>
          </label>

          <label class="meal-card">
            <input type="radio" name="mealPreset" value="pastryCoffee" data-carbs="45">
            <div class="emoji">ü•ê</div>
            <div class="meal-main">
              <div class="meal-title">Pastry and coffee</div>
              <div class="meal-meta">Cafe breakfast</div>
              <div class="meal-tag">Refined carbs + caffeine</div>
            </div>
          </label>

          <!-- Protein + carb -->
          <label class="meal-card">
            <input type="radio" name="mealPreset" value="steakPotato" data-carbs="45">
            <div class="emoji">ü•©</div>
            <div class="meal-main">
              <div class="meal-title">Steak and potato</div>
              <div class="meal-meta">Dinner plate</div>
              <div class="meal-tag">Moderate carb + fat</div>
            </div>
          </label>

          <label class="meal-card">
            <input type="radio" name="mealPreset" value="chickenRice" data-carbs="50">
            <div class="emoji">üçó</div>
            <div class="meal-main">
              <div class="meal-title">Chicken and rice</div>
              <div class="meal-meta">Grain bowl, home or takeout</div>
              <div class="meal-tag">Moderate carb</div>
            </div>
          </label>

          <!-- Lighter carb -->
          <label class="meal-card">
            <input type="radio" name="mealPreset" value="saladBread" data-carbs="35">
            <div class="emoji">ü•ó</div>
            <div class="meal-main">
              <div class="meal-title">Big salad with bread</div>
              <div class="meal-meta">Greens plus 1‚Äì2 slices bread</div>
              <div class="meal-tag">Lighter carb</div>
            </div>
          </label>

          <label class="meal-card">
            <input type="radio" name="mealPreset" value="sushi" data-carbs="55">
            <div class="emoji">üç£</div>
            <div class="meal-main">
              <div class="meal-title">Sushi rolls</div>
              <div class="meal-meta">Typical roll set</div>
              <div class="meal-tag">Rice carbs</div>
            </div>
          </label>
        </div>
      </div>

      <div class="field-group">
        <div class="field-label">Did you add dessert?</div>
        <p class="helper-text">Big dessert might be a bowl of ice cream, a big slice of cake, or 2‚Äì3 cookies.</p>
        <div class="chip-row">
          <label class="chip chip-soft active">
            <input type="radio" name="dessert" value="none" checked>
            No dessert
          </label>
          <label class="chip chip-soft">
            <input type="radio" name="dessert" value="small">
            Small dessert (~10 g sugar)
          </label>
          <label class="chip chip-danger">
            <input type="radio" name="dessert" value="big">
            Big dessert (~35 g sugar)
          </label>
        </div>
      </div>

      <div class="field-group">
        <div class="field-label">Coffee and sugary drink around this meal</div>
        <p class="helper-text">Think of drinks you had within a few hours of this plate.</p>

        <div class="columns-2">
          <div>
            <div class="helper-text">Caffeine</div>
            <div class="chip-row">
              <label class="chip chip-soft active">
                <input type="radio" name="caffeineSimple" value="none" checked>
                No caffeine
              </label>
              <label class="chip chip-soft">
                <input type="radio" name="caffeineSimple" value="small">
                Small coffee or tea
              </label>
              <label class="chip chip-danger">
                <input type="radio" name="caffeineSimple" value="strong">
                Strong coffee / energy drink
              </label>
            </div>
          </div>

          <div>
            <div class="helper-text">Sugary drinks</div>
            <div class="chip-row">
              <label class="chip chip-soft active">
                <input type="radio" name="sugaryDrink" value="none" checked>
                No sugary drink
              </label>
              <label class="chip chip-soft">
                <input type="radio" name="sugaryDrink" value="one">
                One soda or sweet drink
              </label>
              <label class="chip chip-danger">
                <input type="radio" name="sugaryDrink" value="big">
                Big or multiple sweet drinks
              </label>
            </div>
          </div>
        </div>
      </div>
    </div><!-- end simpleModePanel -->
        <div id="advancedModePanel" style="display:none; margin-top:0.75rem;">
      <p class="helper-text">
        Use this mode if you know your numbers. If not, stick to the simple presets.
      </p>
      <div class="columns-2">
        <div class="field-group">
          <div class="field-label">Carbs (grams)</div>
          <input id="advancedCarbs" type="number" min="0" step="1" placeholder="e.g. 75">
        </div>
        <div class="field-group">
          <div class="field-label">Added sugar (grams)</div>
          <input id="advancedSugar" type="number" min="0" step="1" placeholder="Dessert + sugary drinks">
          <p class="helper-text">Estimate is fine. This is the extra sugar on top of the main meal carbs.</p>
        </div>
        <div class="field-group">
          <div class="field-label">Caffeine (mg)</div>
          <input id="advancedCaffeine" type="number" min="0" step="10" placeholder="e.g. 80">
          <p class="helper-text">Coffee 80‚Äì120 mg, strong coffee or energy drink 140‚Äì200 mg.</p>
        </div>
      </div>
    </div>

    <div class="field-group" style="margin-top:1.1rem;">
      <div class="field-label">What time did you eat this meal?</div>
      <p class="helper-text">
        If you skip this, the timeline uses "now" to estimate windows.
      </p>
      <div class="time-input-row">
        <input id="mealTimeInput" type="time">
        <button id="useNowBtn" class="inline-button" type="button">Use current time</button>
      </div>
    </div>

    <div class="field-group" style="margin-top:1.2rem;">
      <div class="field-label">Rest of day and sensitivity</div>
      <p class="helper-text">
        These set the "gain knobs" for how much the same spike shows up in your body.
      </p>

      <div class="columns-2">
        <div>
          <div class="field-label" style="margin-top:0.25rem;">
            How carb-heavy has the rest of your day been?
            <span id="dayCarbLabel" class="helper-text">(Medium)</span>
          </div>
          <p class="helper-text">
            0 = mostly light or low carb so far, 2 = lots of bread, pasta, sweets, or snacks earlier.
          </p>
          <div class="chip-row">
            <label class="chip chip-soft">
              <input type="radio" name="dayCarb" value="0">
              Low
            </label>
            <label class="chip chip-soft active">
              <input type="radio" name="dayCarb" value="1" checked>
              Medium
            </label>
            <label class="chip chip-soft">
              <input type="radio" name="dayCarb" value="2">
              High
            </label>
          </div>
        </div>

        <div>
          <div class="field-label" style="margin-top:0.25rem;">
            Visceral sensitivity (gut volume knob)
            <span id="visceralLabel" class="helper-text">(Medium)</span>
          </div>
          <p class="helper-text">
            0 = gut rarely complains, 2 = gut that feels every bubble and stretch.
          </p>
          <div class="chip-row">
            <label class="chip chip-soft">
              <input type="radio" name="visceral" value="0">
              Low
            </label>
            <label class="chip chip-soft active">
              <input type="radio" name="visceral" value="1" checked>
              Medium
            </label>
            <label class="chip chip-soft">
              <input type="radio" name="visceral" value="2">
              High
            </label>
          </div>
        </div>
      </div>

      <div class="field-group">
        <div class="field-label" style="margin-top:0.75rem;">
          Anxiety system sensitivity
          <span id="anxietyLabel" class="helper-text">(Medium)</span>
        </div>
        <p class="helper-text">
          0 = rarely anxious, 2 = nervous system that notices every little crash.
        </p>
        <div class="chip-row">
          <label class="chip chip-soft">
            <input type="radio" name="anxiety" value="0">
            Low
          </label>
          <label class="chip chip-soft active">
            <input type="radio" name="anxiety" value="1" checked>
            Medium
          </label>
          <label class="chip chip-soft">
            <input type="radio" name="anxiety" value="2">
            High
          </label>
        </div>
      </div>
    </div>
  </section>
    <section id="risk-section">
    <h2>Risk gauge</h2>
    <p class="helper-text">
      Scale: 0 to 49 Low, 50 to 74 Moderate, 75 plus High.
    </p>

    <div class="risk-scale">
      <span>Low</span>
      <span>25</span>
      <span>50</span>
      <span>75</span>
      <span>100</span>
    </div>
    <div class="risk-bar">
      <div id="riskBarFill" class="risk-bar-fill"></div>
    </div>

    <div class="risk-score-row">
      <span class="risk-score-main">
        <span id="riskScoreText">0 / 100</span>
      </span>
      <span>
        <span>Current score: </span>
        <span id="riskBucketText" class="risk-chip low">Low</span>
      </span>
    </div>

    <p id="riskMessage" class="muted">
      Biology says this pattern should feel fairly steady for most people.
    </p>
  </section>

  <section id="timeline-section">
    <h2>Spike - crash - recovery timeline</h2>
    <p class="helper-text">
      These windows shift with your score and meal time. Times are approximate and based on physiology,
      not on how "strong" you are.
    </p>

    <div class="timeline-row">
      <div class="timeline-card">
        <div class="timeline-label">Spike window</div>
        <div id="spikeWindowText" class="timeline-main">Set a meal time to see it.</div>
        <div class="timeline-detail">
          Gut filling, blood sugar rising, and sympathetic tone ticking up.
        </div>
      </div>

      <div class="timeline-card">
        <div class="timeline-label">Crash / anxiety window</div>
        <div id="crashWindowText" class="timeline-main">Set a meal time to see it.</div>
        <div class="timeline-detail">
          Insulin and gut hormones pull things down. If your nerves are sensitive, this is where
          "something feels wrong" tends to show up.
        </div>
      </div>

      <div class="timeline-card">
        <div class="timeline-label">Recovery trend</div>
        <div id="recoveryWindowText" class="timeline-main">Set a meal time to see it.</div>
        <div class="timeline-detail">
          Body clears the load, gut quiets, and the nervous system settles back toward baseline.
        </div>
      </div>
    </div>
  </section>

  <section id="summary-section">
    <h2>Quick summary</h2>
    <p id="summaryLine1" class="summary-bullet">
      Enter a meal to see a rough score.
    </p>
    <p id="summaryLine2" class="summary-bullet">
      You will see how carbs, sugar, caffeine, and sensitivity stack to make an early-night or late-night
      worry window more likely. It is about timing and physiology, not personal weakness.
    </p>
    <p id="summaryLine3" class="summary-bullet">
      If this ever feels intense or dangerous, or you are not sure what is going on, that is the moment
      to talk with a doctor or therapist. The goal is to make patterns less scary, not to replace real care.
    </p>
  </section>

  <section id="about-section">
    <h2>What this is and is not</h2>
    <p class="summary-bullet">
      This is a rough timing model for people who notice that carbs, sugar, and caffeine can create waves of
      anxiety a couple of hours later, especially if they also have IBS or visceral hypersensitivity.
    </p>
    <p class="summary-bullet">
      It is not a diagnosis. If you ever have chest pain, severe shortness of breath, or feel unsafe, that is
      an emergency issue for real-world care, not a timing calculator.
    </p>
    <p class="muted" style="margin-top:0.8rem;">
      ¬© 2025 Darkstar747. Free for personal use and community sharing. Not for commercial use, resale, or paywalled
      distribution. Do not repurpose this work for any product or service that charges money.
    </p>
  </section>
    <script>
    // Small helpers
    function clamp(value, min, max) {
      return Math.min(max, Math.max(min, value));
    }

    function getSelectedRadioValue(name, fallback) {
      const el = document.querySelector('input[name="' + name + '"]:checked');
      if (!el) return fallback;
      const v = el.value;
      const n = Number(v);
      return Number.isNaN(n) ? v : n;
    }

    function formatTimeRange(startDate, endDate) {
      const opts = { hour: "numeric", minute: "2-digit" };
      const startStr = startDate.toLocaleTimeString([], opts);
      const endStr = endDate.toLocaleTimeString([], opts);
      return startStr + " - " + endStr;
    }

    // Simple mode sugar and caffeine mappings
    const DESSERT_SUGAR = {
      none: 0,
      small: 10,
      big: 35
    };

    const SUGARY_DRINK_SUGAR = {
      none: 0,
      one: 35,
      big: 60
    };

    const SIMPLE_CAFFEINE = {
      none: 0,
      small: 60,   // small coffee or tea
      strong: 140  // strong coffee or energy drink
    };

    // Hybrid biology-based risk model
    /**
     * inputs:
     *  carbs           grams total carbs from the meal
     *  sugar           grams added sugar (dessert + drinks + extra sugar)
     *  caffeineMg      mg caffeine around the meal
     *  dayCarbLevel    0 = low, 1 = medium, 2 = high (rest of day)
     *  visceralLevel   0 = low, 1 = medium, 2 = high
     *  anxietyLevel    0 = low, 1 = medium, 2 = high
     *
     * returns: integer 0-100
     */
    function computeRiskScore(inputs) {
      const {
        carbs,
        sugar,
        caffeineMg,
        dayCarbLevel,
        visceralLevel,
        anxietyLevel
      } = inputs;

      // 1) Base meal load (carbs + sugar)
      // Carb curve: mostly linear up to about 120 g then flattens.
      const carbNorm = clamp(carbs / 120, 0, 1);
      const baseCarb = 12 + carbNorm * 18;        // 12-30 points

      // Sugar curve: sharper effect per gram, but capped.
      const sugarNorm = clamp(sugar / 60, 0, 1);
      const sugarScore = sugarNorm * 18;          // 0-18 points

      // Baseline "gut load" before stimulants or sensitivity.
      const baseLoad = 8 + baseCarb + sugarScore; // roughly 20-56

      // 2) Stress multipliers: caffeine + rest-of-day carb load.
      let caffeineFactor;
      if (caffeineMg <= 0) {
        caffeineFactor = 1.0;                     // no stimulant
      } else if (caffeineMg < 80) {
        caffeineFactor = 1.12;                    // small coffee or tea
      } else if (caffeineMg < 160) {
        caffeineFactor = 1.22;                    // strong coffee
      } else {
        caffeineFactor = 1.32;                    // energy drink or big stack
      }

      const dayCarbFactors = [1.0, 1.08, 1.16];   // low, medium, high day
      const dayCarbFactor = dayCarbFactors[dayCarbLevel] ?? 1.0;

      const stressAdjusted = baseLoad * caffeineFactor * dayCarbFactor;

      // 3) Sensitivity scaling: gut and anxiety "gain knobs".
      const visceralAdds = [0, 11, 20];           // low, medium, high
      const anxietyAdds = [0, 7, 14];

      const sensitivityAdd =
        (visceralAdds[visceralLevel] ?? 0) +
        (anxietyAdds[anxietyLevel] ?? 0);

      // 4) Final score, clamped.
      const rawScore = stressAdjusted + sensitivityAdd;
      const score = clamp(Math.round(rawScore), 0, 100);

      return score;
    }

    function riskBucket(score) {
      if (score >= 75) return "High";
      if (score >= 50) return "Moderate";
      return "Low";
    }
          document.addEventListener("DOMContentLoaded", function () {
      let currentMode = "simple";

      const simpleModeBtn = document.getElementById("simpleModeBtn");
      const advancedModeBtn = document.getElementById("advancedModeBtn");
      const simpleModePanel = document.getElementById("simpleModePanel");
      const advancedModePanel = document.getElementById("advancedModePanel");
      const clearSimpleBtn = document.getElementById("clearSimpleBtn");
      const useNowBtn = document.getElementById("useNowBtn");
      const mealTimeInput = document.getElementById("mealTimeInput");

      const selectedMealText = document.getElementById("selectedMealText");

      const riskBarFill = document.getElementById("riskBarFill");
      const riskScoreText = document.getElementById("riskScoreText");
      const riskBucketText = document.getElementById("riskBucketText");
      const riskMessage = document.getElementById("riskMessage");

      const spikeWindowText = document.getElementById("spikeWindowText");
      const crashWindowText = document.getElementById("crashWindowText");
      const recoveryWindowText = document.getElementById("recoveryWindowText");

      const summaryLine1 = document.getElementById("summaryLine1");
      const summaryLine2 = document.getElementById("summaryLine2");
      const summaryLine3 = document.getElementById("summaryLine3");

      const dayCarbLabel = document.getElementById("dayCarbLabel");
      const visceralLabel = document.getElementById("visceralLabel");
      const anxietyLabel = document.getElementById("anxietyLabel");

      const advancedCarbs = document.getElementById("advancedCarbs");
      const advancedSugar = document.getElementById("advancedSugar");
      const advancedCaffeine = document.getElementById("advancedCaffeine");

      function setMode(mode) {
        currentMode = mode;
        if (mode === "simple") {
          simpleModeBtn.classList.add("active");
          advancedModeBtn.classList.remove("active");
          simpleModePanel.style.display = "";
          advancedModePanel.style.display = "none";
        } else {
          simpleModeBtn.classList.remove("active");
          advancedModeBtn.classList.add("active");
          simpleModePanel.style.display = "none";
          advancedModePanel.style.display = "";
        }
        recalc();
      }

      simpleModeBtn.addEventListener("click", function () {
        setMode("simple");
      });
      advancedModeBtn.addEventListener("click", function () {
        setMode("advanced");
      });

      useNowBtn.addEventListener("click", function () {
        const now = new Date();
        const hh = String(now.getHours()).padStart(2, "0");
        const mm = String(now.getMinutes()).padStart(2, "0");
        mealTimeInput.value = hh + ":" + mm;
        recalc();
      });

      clearSimpleBtn.addEventListener("click", function () {
        // Clear dessert, sugary drink, caffeine to "none"
        const resetGroups = ["dessert", "sugaryDrink", "caffeineSimple"];
        resetGroups.forEach(function (name) {
          const first = document.querySelector('input[name="' + name + '"][value="none"]');
          if (first) {
            first.checked = true;
          }
        });
        // Reset highlights on chips
        refreshChips();
        recalc();
      });

      function refreshMealCards() {
        const cards = document.querySelectorAll(".meal-card");
        let selectedLabel = "None";
        cards.forEach(function (card) {
          const input = card.querySelector("input[type=radio]");
          if (input && input.checked) {
            card.classList.add("selected");
            const titleEl = card.querySelector(".meal-title");
            if (titleEl) {
              selectedLabel = titleEl.textContent.trim();
            }
          } else if (card) {
            card.classList.remove("selected");
          }
        });
        if (selectedMealText) {
          selectedMealText.textContent = "Selected meal: " + selectedLabel;
        }
      }

      function refreshChips() {
        const chips = document.querySelectorAll(".chip");
        chips.forEach(function (chip) {
          const input = chip.querySelector("input[type=radio]");
          if (!input) return;
          if (input.checked) {
            chip.classList.add("active");
          } else {
            chip.classList.remove("active");
          }
        });

        const dayMap = ["Low", "Medium", "High"];
        const viscMap = ["Low", "Medium", "High"];
        const anxMap = ["Low", "Medium", "High"];

        const dayV = getSelectedRadioValue("dayCarb", 1);
        const visV = getSelectedRadioValue("visceral", 1);
        const anxV = getSelectedRadioValue("anxiety", 1);

        dayCarbLabel.textContent = "(" + dayMap[dayV] + ")";
        visceralLabel.textContent = "(" + viscMap[visV] + ")";
        anxietyLabel.textContent = "(" + anxMap[anxV] + ")";
      }

      function getEffectiveCarbs() {
        if (currentMode === "advanced") {
          return Number(advancedCarbs.value) || 0;
        }
        const selected = document.querySelector('input[name="mealPreset"]:checked');
        if (!selected) return 0;
        return Number(selected.dataset.carbs || 0);
      }

      function getEffectiveSugar() {
        if (currentMode === "advanced") {
          return Number(advancedSugar.value) || 0;
        }
        const dessert = getSelectedRadioValue("dessert", "none");
        const drink = getSelectedRadioValue("sugaryDrink", "none");
        const dessertSugar = DESSERT_SUGAR[dessert] ?? 0;
        const drinkSugar = SUGARY_DRINK_SUGAR[drink] ?? 0;
        return dessertSugar + drinkSugar;
      }

      function getEffectiveCaffeine() {
        if (currentMode === "advanced") {
          return Number(advancedCaffeine.value) || 0;
        }
        const key = getSelectedRadioValue("caffeineSimple", "none");
        return SIMPLE_CAFFEINE[key] ?? 0;
      }

      function updateRiskGauge(score, bucket) {
        riskScoreText.textContent = score + " / 100";

        riskBucketText.textContent = bucket;
        riskBucketText.classList.remove("low", "moderate", "high");
        if (bucket === "High") {
          riskBucketText.classList.add("high");
        } else if (bucket === "Moderate") {
          riskBucketText.classList.add("moderate");
        } else {
          riskBucketText.classList.add("low");
        }

        const width = clamp(score, 0, 100);
        riskBarFill.style.width = width + "%";

        if (bucket === "Low") {
          riskMessage.textContent =
            "Biology says this pattern should feel fairly steady for most people. If you feel off anyway, that is still real.";
        } else if (bucket === "Moderate") {
          riskMessage.textContent =
            "This is a noticeable spike for a sensitive system. You might feel a wave or two, but it often passes without blowing up your day.";
        } else {
          riskMessage.textContent =
            "This is a high-load stack. For sensitive people this is where real anxiety, jitters, or gut unease often show up a couple of hours later.";
        }
      }
                  function getMealAnchorTime() {
        const now = new Date();
        const timeStr = mealTimeInput.value;
        if (!timeStr) return now;

        const parts = timeStr.split(":");
        if (parts.length < 2) return now;
        const hh = Number(parts[0]);
        const mm = Number(parts[1]);
        if (Number.isNaN(hh) || Number.isNaN(mm)) return now;

        const anchor = new Date();
        anchor.setHours(hh);
        anchor.setMinutes(mm);
        anchor.setSeconds(0);
        anchor.setMilliseconds(0);
        return anchor;
      }

      function updateTimeline(score) {
        const anchor = getMealAnchorTime();

        // Base offsets in minutes
        let spikeStart = 20;
        let spikeEnd = 90;
        let crashStart = 90;
        let crashEnd = 210;
        let recoveryEnd = 360;

        // If the score is higher, stretch crash and recovery a bit later.
        const intensity = score / 100;
        spikeEnd += Math.round(10 * intensity);
        crashStart += Math.round(15 * intensity);
        crashEnd += Math.round(30 * intensity);
        recoveryEnd += Math.round(30 * intensity);

        const spikeStartDate = new Date(anchor.getTime() + spikeStart * 60000);
        const spikeEndDate = new Date(anchor.getTime() + spikeEnd * 60000);

        const crashStartDate = new Date(anchor.getTime() + crashStart * 60000);
        const crashEndDate = new Date(anchor.getTime() + crashEnd * 60000);

        const recoveryStartDate = crashEndDate;
        const recoveryEndDate = new Date(anchor.getTime() + recoveryEnd * 60000);

        spikeWindowText.textContent = formatTimeRange(spikeStartDate, spikeEndDate);
        crashWindowText.textContent = formatTimeRange(crashStartDate, crashEndDate);
        recoveryWindowText.textContent = formatTimeRange(recoveryStartDate, recoveryEndDate);
      }

      function updateSummary(score, bucket) {
        if (score === 0) {
          summaryLine1.textContent = "Enter a meal to see a rough score.";
          summaryLine2.textContent =
            "You will see how carbs, sugar, caffeine, and sensitivity stack to make an early-night or late-night worry window more likely. It is about timing and physiology, not personal weakness.";
          summaryLine3.textContent =
            "If this ever feels intense or dangerous, or you are not sure what is going on, that is the moment to talk with a doctor or therapist. The goal is to make patterns less scary, not to replace real care.";
          return;
        }

        summaryLine1.textContent =
          "This stack lands at " + score + " out of 100, which sits in the " + bucket + " range.";

        if (bucket === "Low") {
          summaryLine2.textContent =
            "For most people, this pattern is more of a gentle rise and fall than a big spike. If you still feel weird, that tells you your wiring is extra sensitive today, not that you are doing anything wrong.";
          summaryLine3.textContent =
            "You can use this as a low-load reference day: \"this is roughly what my body calls calm\".";
        } else if (bucket === "Moderate") {
          summaryLine2.textContent =
            "This is a noticeable load for a sensitive gut and nervous system. You might feel a wave of unease, shakiness, or vague dread in the crash window, especially if sleep or stress have been off.";
          summaryLine3.textContent =
            "Sometimes shifting one thing, like earlier caffeine or smaller dessert, is enough to pull a Moderate day back toward comfortable.";
        } else {
          summaryLine2.textContent =
            "This is a high-load pattern. For people with IBS, visceral hypersensitivity, or a jumpy anxiety system, this is the zone where true spikes, rumbling gut, and strong nervous system reactions often show up.";
          summaryLine3.textContent =
            "If this matches a real trigger pattern for you, you can use it as a reference. The goal is not perfection, just to have fewer red-alert days and more days where your body feels like it can exhale.";
        }
      }

      function recalc() {
        refreshMealCards();
        refreshChips();

        const carbs = getEffectiveCarbs();
        const sugar = getEffectiveSugar();
        const caffeineMg = getEffectiveCaffeine();

        const dayCarbLevel = getSelectedRadioValue("dayCarb", 1);
        const visceralLevel = getSelectedRadioValue("visceral", 1);
        const anxietyLevel = getSelectedRadioValue("anxiety", 1);

        const score = computeRiskScore({
          carbs: carbs,
          sugar: sugar,
          caffeineMg: caffeineMg,
          dayCarbLevel: dayCarbLevel,
          visceralLevel: visceralLevel,
          anxietyLevel: anxietyLevel
        });

        const bucket = riskBucket(score);

        updateRiskGauge(score, bucket);
        updateTimeline(score);
        updateSummary(score, bucket);
      }

      // Wire up listeners
      document.querySelectorAll("input[type=radio]").forEach(function (input) {
        input.addEventListener("change", function () {
          refreshMealCards();
          refreshChips();
          recalc();
        });
      });

      [advancedCarbs, advancedSugar, advancedCaffeine].forEach(function (input) {
        if (!input) return;
        input.addEventListener("input", recalc);
      });

      if (mealTimeInput) {
        mealTimeInput.addEventListener("change", recalc);
      }

      // Initial refresh
      refreshMealCards();
      refreshChips();
      recalc();
    });
  </script>
</main>
</body>
</html>
            
